<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <title>Portfolio - Initiate Coverage</title>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#1e3a5f">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Initiate Coverage">
  <link rel="apple-touch-icon" href="/icons/icon-192.png">
  <!-- Google Identity Services for Sign-In -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #f8f9fa;
      color: #202124;
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
    }

    /* Navigation Banner - V4: Compact Data-Focused */
    .nav-strip {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 44px;
      background: #ffffff;
      border-bottom: 1px solid #eaecef;
      display: flex;
      align-items: center;
      padding: 0 20px;
      z-index: 1000;
      gap: 0;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
      color: #0b0e11;
      margin-right: 24px;
      flex-shrink: 0;
    }

    .brand-ic {
      font-size: 16px;
      font-weight: 800;
      color: #1e3a5f;
      letter-spacing: -1px;
    }

    .brand-sep {
      width: 1px;
      height: 18px;
      background: #eaecef;
    }

    .nav-tabs {
      display: flex;
      align-items: stretch;
      height: 44px;
      gap: 0;
      flex-shrink: 0;
    }

    .nav-tab {
      text-decoration: none;
      font-size: 13px;
      font-weight: 500;
      color: #848e9c;
      padding: 0 14px;
      display: flex;
      align-items: center;
      border-bottom: 2px solid transparent;
      transition: all 0.15s ease;
      white-space: nowrap;
    }

    .nav-tab:hover {
      color: #474d57;
    }

    .nav-tab.active {
      color: #1e3a5f;
      border-bottom-color: #1e3a5f;
      font-weight: 600;
    }

    @media (max-width: 768px) {
      .nav-strip { padding: 0 12px; }
      .brand { margin-right: 12px; }
      .nav-tab { font-size: 12px; padding: 0 10px; }
    }

    @media (max-width: 480px) {
      .nav-tab { font-size: 10px; padding: 0 5px; }
      .brand-sep { display: none; }
    }

    /* Main Content */
    .main-content {
      max-width: 1050px;
      margin: 0 auto;
      padding: 32px;
      padding-top: 72px;
    }

    /* Page Header */
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .page-title {
      font-size: 28px;
      font-weight: 600;
      color: #1e3a5f;
      margin-bottom: 8px;
    }

    .auth-section {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-info {
      font-size: 14px;
      color: #5f6368;
    }

    .auth-btn {
      background: #00205b;
      color: white;
      border: none;
      padding: 8px 16px;
      font-size: 13px;
      font-weight: 500;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .auth-btn:hover {
      background: #003087;
    }

    .auth-btn.secondary {
      background: transparent;
      color: #00205b;
      border: 1px solid #dadce0;
    }

    .auth-btn.secondary:hover {
      background: #f8f9fa;
      border-color: #00205b;
    }

    /* Watchlist Tabs - removed, Popular is now in the watchlist selector */

    /* Watchlist Selector (for logged-in users with multiple server watchlists) */
    .watchlist-selector {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .watchlist-dropdown {
      padding: 8px 32px 8px 12px;
      font-size: 14px;
      font-weight: 500;
      border: 1px solid #dadce0;
      border-radius: 4px;
      background: white url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%235f6368' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E") no-repeat right 10px center;
      cursor: pointer;
      min-width: 200px;
      appearance: none;
      -webkit-appearance: none;
    }

    .watchlist-dropdown:hover {
      border-color: #00205b;
    }

    .watchlist-dropdown:focus {
      outline: none;
      border-color: #00205b;
      box-shadow: 0 0 0 2px rgba(0, 32, 91, 0.1);
    }

    .new-watchlist-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      font-size: 13px;
      font-weight: 500;
      color: #00205b;
      background: transparent;
      border: 1px solid #dadce0;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .new-watchlist-btn:hover {
      background: #f8f9fa;
      border-color: #00205b;
    }

    .watchlist-actions-btn {
      padding: 6px 10px;
      font-size: 13px;
      color: #5f6368;
      background: transparent;
      border: 1px solid #dadce0;
      border-radius: 4px;
      cursor: pointer;
    }

    .watchlist-actions-btn:hover {
      background: #f8f9fa;
      color: #202124;
    }

    /* Add Stock Section */
    .add-stock-section {
      background: #ffffff;
      border-radius: 8px;
      padding: 20px 24px;
      border: 1px solid #e8eaed;
      box-shadow: 0 1px 2px rgba(60, 64, 67, 0.1);
      margin-bottom: 24px;
    }

    .add-stock-form {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .ticker-input {
      flex: 1;
      max-width: 200px;
      padding: 12px 16px;
      border: 1px solid #dadce0;
      border-radius: 4px;
      font-size: 14px;
      text-transform: uppercase;
      font-weight: 500;
      letter-spacing: 0.5px;
    }

    .ticker-input:focus {
      outline: none;
      border-color: #00205b;
      box-shadow: 0 0 0 2px rgba(0, 32, 91, 0.1);
    }

    .add-btn {
      background: #00205b;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 14px;
      font-weight: 500;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .add-btn:hover {
      background: #003087;
    }

    .add-btn:disabled {
      background: #9aa0a6;
      cursor: not-allowed;
    }

    .login-prompt {
      font-size: 13px;
      color: #5f6368;
      margin-left: auto;
    }

    .login-prompt a {
      color: #00205b;
      text-decoration: none;
      font-weight: 500;
    }

    .login-prompt a:hover {
      text-decoration: underline;
    }

    /* Watchlist Table */
    .watchlist-section {
      background: #ffffff;
      border-radius: 8px;
      border: 1px solid #e8eaed;
      box-shadow: 0 1px 2px rgba(60, 64, 67, 0.1);
      overflow-x: auto;
    }

    .watchlist-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 24px;
      border-bottom: 1px solid #e8eaed;
      background: #f8f9fa;
    }

    .watchlist-title {
      font-size: 16px;
      font-weight: 500;
      color: #202124;
    }

    .refresh-info {
      font-size: 12px;
      color: #5f6368;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .refresh-btn {
      background: transparent;
      color: #00205b;
      border: 1px solid #dadce0;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 500;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .refresh-btn:hover {
      background: #f8f9fa;
      border-color: #00205b;
    }

    /* Stock Table Header */
    .stock-table-header {
      display: grid;
      gap: 8px;
      align-items: center;
      padding: 10px 24px;
      border-bottom: 1px solid #e8eaed;
      background: #f8f9fa;
    }

    .col-header {
      font-size: 11px;
      font-weight: 600;
      color: #5f6368;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .col-header.right {
      text-align: right;
    }

    /* Stock Row */
    .stock-row {
      display: grid;
      gap: 8px;
      align-items: center;
      padding: 14px 24px;
      border-bottom: 1px solid #e8eaed;
      transition: background 0.15s;
      cursor: pointer;
    }

    .stock-row:last-child {
      border-bottom: none;
    }

    .stock-row:hover {
      background: #f8f9fa;
    }

    .stock-ticker {
      font-size: 14px;
      font-weight: 600;
      color: #00205b;
    }

    .stock-name {
      font-size: 13px;
      color: #3c4043;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .stock-price {
      font-size: 13px;
      font-weight: 500;
      color: #202124;
      text-align: right;
    }

    .stock-change {
      font-size: 13px;
      font-weight: 600;
      text-align: right;
    }

    .stock-change.positive {
      color: #137333;
    }

    .stock-change.negative {
      color: #c5221f;
    }

    .stock-change.neutral {
      color: #5f6368;
    }

    .remove-btn {
      background: transparent;
      border: none;
      color: #9aa0a6;
      cursor: pointer;
      padding: 6px;
      border-radius: 4px;
      transition: all 0.2s;
    }

    .remove-btn:hover {
      background: #fce8e6;
      color: #c5221f;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 24px;
      color: #5f6368;
    }

    .empty-state h3 {
      font-size: 16px;
      font-weight: 500;
      margin-bottom: 8px;
      color: #202124;
    }

    .empty-state p {
      font-size: 14px;
    }

    /* Loading State */
    .loading-row {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
      color: #5f6368;
      font-size: 14px;
    }

    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid #e8eaed;
      border-top-color: #00205b;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 12px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Auth Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: white;
      border-radius: 8px;
      width: 400px;
      max-width: 90%;
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.2);
    }

    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid #e8eaed;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-size: 18px;
      font-weight: 500;
      color: #202124;
    }

    .modal-close {
      background: transparent;
      border: none;
      font-size: 24px;
      color: #5f6368;
      cursor: pointer;
      padding: 4px;
      line-height: 1;
    }

    .modal-close:hover {
      color: #202124;
    }

    .modal-body {
      padding: 24px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group:last-child {
      margin-bottom: 0;
    }

    .form-label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: #3c4043;
      margin-bottom: 6px;
    }

    .form-input {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid #dadce0;
      border-radius: 4px;
      font-size: 14px;
    }

    .form-input:focus {
      outline: none;
      border-color: #00205b;
      box-shadow: 0 0 0 2px rgba(0, 32, 91, 0.1);
    }

    .form-error {
      color: #c5221f;
      font-size: 13px;
      margin-top: 6px;
      display: none;
    }

    .form-error.visible {
      display: block;
    }

    .form-submit {
      width: 100%;
      background: #00205b;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 14px;
      font-weight: 500;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
      margin-top: 8px;
    }

    .form-submit:hover {
      background: #003087;
    }

    .form-submit:disabled {
      background: #9aa0a6;
      cursor: not-allowed;
    }

    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid #e8eaed;
      text-align: center;
      font-size: 13px;
      color: #5f6368;
    }

    .modal-footer a {
      color: #00205b;
      text-decoration: none;
      font-weight: 500;
    }

    .modal-footer a:hover {
      text-decoration: underline;
    }

    /* Tab Switcher */
    .auth-tabs {
      display: flex;
      border-bottom: 1px solid #e8eaed;
    }

    .auth-tab {
      flex: 1;
      padding: 12px;
      text-align: center;
      font-size: 14px;
      font-weight: 500;
      color: #5f6368;
      background: transparent;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
    }

    .auth-tab:hover {
      color: #202124;
      background: #f8f9fa;
    }

    .auth-tab.active {
      color: #00205b;
      border-bottom: 2px solid #00205b;
      margin-bottom: -1px;
    }

    /* Google Sign-In */
    .google-signin-container {
      display: flex;
      justify-content: center;
      margin-bottom: 16px;
    }

    .auth-divider {
      display: flex;
      align-items: center;
      margin: 20px 0;
      color: #5f6368;
      font-size: 13px;
    }

    .auth-divider::before,
    .auth-divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: #dadce0;
    }

    .auth-divider span {
      padding: 0 16px;
    }

    /* Sortable Column Headers */
    .col-header.sortable {
      cursor: pointer;
      user-select: none;
      transition: color 0.15s ease;
      display: inline-flex;
      align-items: center;
      gap: 3px;
    }

    .col-header.sortable:hover {
      color: #202124;
    }

    .col-header.sortable.right {
      justify-content: flex-end;
    }

    .col-header.sortable.active {
      color: #1a73e8;
    }

    .sort-arrow {
      font-size: 9px;
      line-height: 1;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .main-content {
        padding: 24px 16px;
        padding-top: 64px;
      }

      .page-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 16px;
      }

      .add-stock-form {
        flex-wrap: wrap;
      }

      .ticker-input {
        max-width: none;
        flex: 1;
        min-width: 120px;
      }

      .login-prompt {
        margin-left: 0;
        margin-top: 8px;
        width: 100%;
      }

      .stock-table-header {
        gap: 4px;
        padding: 8px 12px;
      }

      .col-header {
        font-size: 10px;
      }

      .stock-row {
        gap: 4px;
        padding: 10px 12px;
      }

      .stock-ticker {
        font-size: 12px;
      }

      .stock-name {
        font-size: 11px;
      }

      .stock-price {
        font-size: 11px;
      }

      .stock-change {
        font-size: 11px;
      }

    }

    /* Side Panel Overlay */
    .panel-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.4);
      z-index: 2000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .panel-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    /* Side Panel */
    .side-panel {
      position: fixed;
      top: 0;
      right: 0;
      width: 560px;
      max-width: 100%;
      height: 100vh;
      background: #ffffff;
      z-index: 2001;
      display: flex;
      flex-direction: column;
      box-shadow: -4px 0 24px rgba(0, 0, 0, 0.15);
      transform: translateX(100%);
      transition: transform 0.3s ease-out;
    }

    .side-panel.active {
      transform: translateX(0);
    }

    /* Panel Header */
    .panel-header {
      background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
      padding: 24px;
      color: white;
      position: relative;
      flex-shrink: 0;
    }

    .panel-close-button {
      position: absolute;
      top: 16px;
      right: 16px;
      width: 36px;
      height: 36px;
      border: none;
      background: rgba(255, 255, 255, 0.15);
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.2s;
      z-index: 1;
    }

    .panel-close-button:hover {
      background: rgba(255, 255, 255, 0.25);
    }

    .panel-close-button svg {
      width: 20px;
      height: 20px;
      color: white;
    }

    .panel-label {
      font-family: Arial, sans-serif;
      font-size: 12px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 1px;
      opacity: 0.8;
      margin-bottom: 8px;
    }

    .panel-title {
      font-family: Arial, sans-serif;
      font-size: 20px;
      font-weight: 600;
      line-height: 1.4;
      padding-right: 40px;
      margin: 0;
    }

    .panel-ticker {
      font-family: Arial, sans-serif;
      font-size: 14px;
      opacity: 0.9;
      margin-top: 4px;
    }

    .panel-content {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
    }

    /* Panel Footer */
    .panel-footer {
      padding: 16px 24px;
      background: #f8f9fa;
      border-top: 1px solid #e0e0e0;
      flex-shrink: 0;
    }

    .panel-footer-btn {
      font-family: Arial, sans-serif;
      width: 100%;
      background: #1e3a5f;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 14px;
      font-weight: 500;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .panel-footer-btn:hover {
      background: #2d5a87;
    }

    /* Panel Price Display - Google Finance style */
    .panel-price-display {
      display: flex;
      flex-direction: column;
      margin-bottom: 16px;
    }

    .panel-price-value {
      font-family: Arial, sans-serif;
      font-size: 36px;
      font-weight: 700;
      color: #202124;
      letter-spacing: -0.5px;
      line-height: 1.2;
    }

    .panel-price-change {
      font-family: Arial, sans-serif;
      font-size: 16px;
      font-weight: 500;
      margin-top: 4px;
      line-height: 1.4;
    }

    .panel-price-change.positive {
      color: #137333;
    }

    .panel-price-change.negative {
      color: #a50e0e;
    }

    .panel-price-date {
      font-family: Arial, sans-serif;
      font-size: 13px;
      color: #70757a;
      margin-top: 2px;
      line-height: 1.4;
    }

    /* Timeframe Tabs */
    .chart-timeframe-tabs {
      display: flex;
      gap: 0;
      margin: 16px 0 8px 0;
      border-bottom: 1px solid #e8eaed;
    }

    .chart-tab {
      padding: 8px 12px;
      font-size: 12px;
      font-weight: 500;
      color: #5f6368;
      background: none;
      border: none;
      cursor: pointer;
      position: relative;
      transition: color 0.2s;
    }

    .chart-tab:hover {
      color: #202124;
    }

    .chart-tab.active {
      color: #1a73e8;
    }

    .chart-tab.active::after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 0;
      right: 0;
      height: 3px;
      background: #1a73e8;
      border-radius: 3px 3px 0 0;
    }

    /* Chart Container */
    .chart-container {
      position: relative;
      width: 100%;
      height: 200px;
      margin: 8px 0 16px 0;
    }

    .chart-container svg {
      width: 100%;
      height: 100%;
    }

    .chart-loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: #5f6368;
      font-family: Arial, sans-serif;
      font-size: 13px;
    }

    .chart-loading .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid #e0e0e0;
      border-top-color: #00205b;
      margin-right: 8px;
    }

    /* Chart tooltip */
    .chart-tooltip {
      position: absolute;
      background: #202124;
      color: white;
      padding: 5px 9px;
      border-radius: 6px;
      font-size: 11px;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.15s;
      white-space: nowrap;
      z-index: 10;
    }

    .chart-tooltip.visible {
      opacity: 1;
    }

    /* Streaming status */
    .panel-status {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 20px 0;
      color: #666;
      font-family: Arial, sans-serif;
      font-size: 14px;
    }

    .panel-status .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid #e0e0e0;
      border-top-color: #666;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    /* Analysis Section */
    .panel-section {
      margin-bottom: 24px;
    }

    .section-title {
      font-family: Arial, sans-serif;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #1e3a5f;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 2px solid #e8f0f7;
    }

    .section-content {
      font-family: 'Times New Roman', Georgia, serif;
      color: #444;
      line-height: 1.7;
      font-size: 15px;
    }

    .section-content p {
      margin-bottom: 12px;
    }

    .section-content p:last-child {
      margin-bottom: 0;
    }

    .section-content strong {
      color: #1e3a5f;
      font-weight: 600;
    }

    /* Loading Skeleton */
    .skeleton {
      background: linear-gradient(90deg, #f0f0f0 25%, #e8e8e8 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: 4px;
    }

    .skeleton-section {
      margin-bottom: 24px;
    }

    .skeleton-label {
      height: 12px;
      width: 100px;
      margin-bottom: 12px;
    }

    .skeleton-line {
      height: 16px;
      margin-bottom: 10px;
    }

    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    .panel-error {
      text-align: center;
      padding: 40px 20px;
      color: #c62828;
      font-family: Arial, sans-serif;
      font-size: 14px;
    }


    /* Responsive - Side Panel */
    @media (max-width: 520px) {
      .side-panel {
        width: 100%;
      }

      .panel-header {
        padding: 20px;
      }

      .panel-title {
        font-size: 18px;
      }

      .panel-content {
        padding: 20px;
      }
    }

    /* Toast Notification */
    .toast-container {
      position: fixed;
      top: 60px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 3000;
      display: flex;
      flex-direction: column;
      gap: 8px;
      pointer-events: none;
    }

    .toast {
      background: #1e3a5f;
      color: white;
      padding: 14px 24px;
      border-radius: 8px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 14px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
      opacity: 0;
      transform: translateY(-20px);
      transition: opacity 0.3s ease, transform 0.3s ease;
      pointer-events: auto;
      max-width: 400px;
      text-align: center;
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }

    .toast.error {
      background: #c62828;
    }

    .toast.success {
      background: #2e7d32;
    }

    /* ===== Bottom Tab Bar (Mobile) ===== */
    .bottom-tab-bar {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #00205b;
      z-index: 1000;
      padding-bottom: env(safe-area-inset-bottom);
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.15);
    }

    .bottom-tab-bar .tab-items {
      display: flex;
      justify-content: space-around;
      align-items: center;
      height: 56px;
    }

    .bottom-tab-bar .tab-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-decoration: none;
      color: rgba(255, 255, 255, 0.6);
      font-size: 9px;
      font-weight: 500;
      gap: 3px;
      padding: 6px 4px;
      min-width: 0;
      flex: 1;
      -webkit-tap-highlight-color: transparent;
      transition: color 0.2s;
    }

    .bottom-tab-bar .tab-item.active {
      color: white;
    }

    .bottom-tab-bar .tab-item svg {
      width: 22px;
      height: 22px;
    }

    .bottom-tab-bar .tab-label {
      line-height: 1;
    }

    @media (max-width: 768px) {
      .nav-strip {
        display: none;
      }

      .bottom-tab-bar {
        display: block;
      }

      body {
        padding-top: env(safe-area-inset-top);
        padding-bottom: calc(56px + env(safe-area-inset-bottom));
      }

      .main-content {
        padding: 24px 16px;
        padding-top: calc(24px + env(safe-area-inset-top));
      }

      .side-panel {
        width: 100%;
        height: 100%;
      }

      .page-title {
        font-size: 22px;
      }

      .page-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }
    }
  </style>
</head>
<body>
  <!-- Toast Container -->
  <div class="toast-container" id="toast-container"></div>

  <nav class="nav-strip">
    <a href="/market" class="brand">
      <span class="brand-ic">IC</span>
    </a>
    <div class="brand-sep"></div>
    <div class="nav-tabs">
      <a href="/market" class="nav-tab">Market Update</a>
      <a href="/top-movers" class="nav-tab">Top Movers</a>
      <a href="/portfolio" class="nav-tab active">Portfolio</a>
      <a href="/ideageneration" class="nav-tab">Idea Generation</a>
      <a href="/index.html" class="nav-tab">Initiation</a>
    </div>
  </nav>

  <main class="main-content">
    <div class="page-header">
      <h1 class="page-title">Portfolio</h1>
      <div class="auth-section" id="auth-section">
        <!-- Dynamically populated based on auth state -->
      </div>
    </div>

    <!-- Watchlist Selector (always visible) -->
    <div class="watchlist-selector" id="watchlist-selector" style="display: flex;">
      <select id="watchlist-select" class="watchlist-dropdown">
        <!-- Options populated dynamically; always includes Popular -->
      </select>
      <button class="new-watchlist-btn" id="new-watchlist-btn" onclick="showCreateWatchlistModal()" style="display: none;">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 5v14M5 12h14"/>
        </svg>
        New
      </button>
      <button class="watchlist-actions-btn" onclick="showWatchlistActionsMenu()" id="watchlist-actions-btn" title="More actions" style="display: none;">
        &#x22EF;
      </button>
    </div>

    <!-- Add Stock Section -->
    <div class="add-stock-section" id="add-stock-section" style="display: none;">
      <form class="add-stock-form" id="add-stock-form">
        <input type="text" class="ticker-input" id="ticker-input" placeholder="Enter ticker (e.g., AAPL)" maxlength="10">
        <button type="submit" class="add-btn" id="add-btn">Add to Watchlist</button>
        <span class="login-prompt" id="login-prompt" style="display: none;">
          <a href="#" id="login-link">Login</a> to save your watchlist
        </span>
      </form>
    </div>

    <div class="watchlist-section">
      <div class="watchlist-header">
        <span class="watchlist-title" id="watchlist-title-label">Popular Stocks</span>
        <div class="refresh-info">
          <span id="last-updated">--</span>
          <button class="refresh-btn" id="refresh-btn">Refresh</button>
        </div>
      </div>
      <div id="watchlist-container">
        <!-- Watchlist items will be rendered here -->
      </div>
    </div>
  </main>

  <!-- Auth Modal -->
  <div class="modal-overlay" id="auth-modal">
    <div class="modal">
      <div class="auth-tabs">
        <button class="auth-tab active" data-tab="login">Login</button>
        <button class="auth-tab" data-tab="signup">Sign Up</button>
      </div>

      <!-- Login Form -->
      <div id="login-form-container">
        <div class="modal-header">
          <span class="modal-title">Welcome Back</span>
          <button class="modal-close" id="modal-close">&times;</button>
        </div>
        <div class="modal-body">
          <!-- Google Sign-In Button -->
          <div id="google-signin-btn-login" class="google-signin-container"></div>

          <!-- Divider -->
          <div class="auth-divider">
            <span>or continue with email</span>
          </div>

          <form id="login-form">
            <div class="form-group">
              <label class="form-label" for="login-email">Email</label>
              <input type="email" class="form-input" id="login-email" required>
            </div>
            <div class="form-group">
              <label class="form-label" for="login-password">Password</label>
              <input type="password" class="form-input" id="login-password" required>
            </div>
            <div class="form-error" id="login-error"></div>
            <button type="submit" class="form-submit" id="login-submit">Login</button>
          </form>
        </div>
      </div>

      <!-- Signup Form -->
      <div id="signup-form-container" style="display: none;">
        <div class="modal-header">
          <span class="modal-title">Create Account</span>
          <button class="modal-close" id="modal-close-signup">&times;</button>
        </div>
        <div class="modal-body">
          <!-- Google Sign-In Button -->
          <div id="google-signin-btn-signup" class="google-signin-container"></div>

          <!-- Divider -->
          <div class="auth-divider">
            <span>or continue with email</span>
          </div>

          <form id="signup-form">
            <div class="form-group">
              <label class="form-label" for="signup-email">Email</label>
              <input type="email" class="form-input" id="signup-email" required>
            </div>
            <div class="form-group">
              <label class="form-label" for="signup-password">Password</label>
              <input type="password" class="form-input" id="signup-password" minlength="6" required>
            </div>
            <div class="form-group">
              <label class="form-label" for="signup-confirm">Confirm Password</label>
              <input type="password" class="form-input" id="signup-confirm" minlength="6" required>
            </div>
            <div class="form-error" id="signup-error"></div>
            <button type="submit" class="form-submit" id="signup-submit">Create Account</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Create Watchlist Modal -->
  <div class="modal-overlay" id="create-watchlist-modal">
    <div class="modal" style="max-width: 400px;">
      <div class="modal-header">
        <span class="modal-title">Create New Watchlist</span>
        <button class="modal-close" onclick="hideCreateWatchlistModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="create-watchlist-form">
          <div class="form-group">
            <label class="form-label" for="new-watchlist-name">Watchlist Name</label>
            <input type="text" class="form-input" id="new-watchlist-name" maxlength="50" placeholder="e.g., Tech Stocks" required>
          </div>
          <button type="submit" class="form-submit">Create Watchlist</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Rename Watchlist Modal -->
  <div class="modal-overlay" id="rename-watchlist-modal">
    <div class="modal" style="max-width: 400px;">
      <div class="modal-header">
        <span class="modal-title">Rename Watchlist</span>
        <button class="modal-close" onclick="hideRenameWatchlistModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="rename-watchlist-form">
          <div class="form-group">
            <label class="form-label" for="rename-watchlist-name">Watchlist Name</label>
            <input type="text" class="form-input" id="rename-watchlist-name" maxlength="50" required>
          </div>
          <button type="submit" class="form-submit">Rename</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Watchlist Actions Menu -->
  <div class="watchlist-actions-menu" id="watchlist-actions-menu" style="display: none; position: absolute; background: white; border: 1px solid #dadce0; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; min-width: 150px;">
    <div style="padding: 8px 16px; cursor: pointer; font-size: 14px;" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='white'" onclick="showRenameWatchlistModal()">Rename</div>
    <div style="padding: 8px 16px; cursor: pointer; font-size: 14px; color: #c5221f;" onmouseover="this.style.background='#fce8e6'" onmouseout="this.style.background='white'" onclick="deleteCurrentWatchlist()">Delete</div>
  </div>

  <script>
    // Google Sign-In Configuration
    // NOTE: To enable Google Sign-In, you need to:
    // 1. Create a Google Cloud project at https://console.cloud.google.com/
    // 2. Enable the Google+ API
    // 3. Create OAuth 2.0 credentials (Web application type)
    // 4. Add your domain to the authorized JavaScript origins
    // 5. Replace the CLIENT_ID below with your actual Google Client ID
    const GOOGLE_CLIENT_ID = '526500240893-io4bf4eveom20ld8jv1k5qs7m6a4tn5j.apps.googleusercontent.com';

    // Popular watchlist (default preset, editable via localStorage)
    const DEFAULT_POPULAR_WATCHLIST = ['AAPL', 'MSFT', 'GOOGL', 'AMZN', 'NVDA', 'META', 'TSLA', 'BTC-USD'];
    let popularWatchlist = JSON.parse(localStorage.getItem('popularWatchlist') || 'null') || [...DEFAULT_POPULAR_WATCHLIST];

    // State
    let currentUser = null;
    let authToken = localStorage.getItem('authToken');
    let portfolioWatchlist = JSON.parse(localStorage.getItem('localWatchlist') || '[]');
    let watchlist = [...popularWatchlist]; // currently displayed list
    let stockPerformance = {};
    let refreshInterval = null;
    let googleInitialized = false;

    // Sort state
    let currentSortKey = '1D';   // Default sort by 1D change
    let currentSortDir = 'desc'; // 'asc' or 'desc' â€” desc = biggest gainers first

    // Multiple watchlists state
    let watchlistsData = null;  // Full watchlist data from server
    let currentWatchlistId = '__popular__';  // Currently selected watchlist ID (starts on Popular)

    // DOM Elements
    const authSection = document.getElementById('auth-section');
    const authModal = document.getElementById('auth-modal');
    const loginFormContainer = document.getElementById('login-form-container');
    const signupFormContainer = document.getElementById('signup-form-container');
    const loginForm = document.getElementById('login-form');
    const signupForm = document.getElementById('signup-form');
    const loginError = document.getElementById('login-error');
    const signupError = document.getElementById('signup-error');
    const addStockForm = document.getElementById('add-stock-form');
    const tickerInput = document.getElementById('ticker-input');
    const loginPrompt = document.getElementById('login-prompt');
    const watchlistContainer = document.getElementById('watchlist-container');
    const refreshBtn = document.getElementById('refresh-btn');
    const lastUpdated = document.getElementById('last-updated');

    // Initialize
    init();

    async function init() {
      // Check for existing auth
      if (authToken) {
        try {
          const response = await fetch('/api/auth/me', {
            headers: { 'Authorization': `Bearer ${authToken}` }
          });
          if (response.ok) {
            const data = await response.json();
            currentUser = data.user;
            await loadServerWatchlist();
          } else {
            // Invalid token
            authToken = null;
            localStorage.removeItem('authToken');
          }
        } catch (err) {
          console.error('Auth check failed:', err);
        }
      }

      updateAuthUI();
      applyActiveWatchlist();
      renderWatchlistSelector();
      renderWatchlist();

      // Start auto-refresh
      startAutoRefresh();
    }

    // Returns true if the currently selected watchlist is the Popular one
    function isPopularSelected() {
      return currentWatchlistId === '__popular__';
    }

    // Apply the selected watchlist to the UI
    function applyActiveWatchlist() {
      const addStockSection = document.getElementById('add-stock-section');
      const watchlistTitleLabel = document.getElementById('watchlist-title-label');
      const newWatchlistBtn = document.getElementById('new-watchlist-btn');
      const actionsBtn = document.getElementById('watchlist-actions-btn');

      if (isPopularSelected()) {
        // Popular: editable, saved to localStorage
        addStockSection.style.display = 'block';
        watchlistTitleLabel.textContent = 'Popular Stocks';
        watchlist = [...popularWatchlist];
        // Show New button only if logged in; never show actions for Popular
        newWatchlistBtn.style.display = currentUser ? 'flex' : 'none';
        actionsBtn.style.display = 'none';
      } else if (currentUser && watchlistsData && watchlistsData.watchlists[currentWatchlistId]) {
        // Server watchlist: editable
        addStockSection.style.display = 'block';
        const wlName = watchlistsData.watchlists[currentWatchlistId].name;
        watchlistTitleLabel.textContent = wlName;
        watchlist = watchlistsData.watchlists[currentWatchlistId].tickers || [];
        newWatchlistBtn.style.display = 'flex';
        actionsBtn.style.display = 'inline-block';
      } else if (!currentUser && currentWatchlistId === '__local__') {
        // Local (not logged in) portfolio
        addStockSection.style.display = 'block';
        watchlistTitleLabel.textContent = 'My Watchlist';
        watchlist = portfolioWatchlist;
        newWatchlistBtn.style.display = 'none';
        actionsBtn.style.display = 'none';
      } else {
        // Fallback: show Popular
        currentWatchlistId = '__popular__';
        addStockSection.style.display = 'block';
        watchlistTitleLabel.textContent = 'Popular Stocks';
        watchlist = [...popularWatchlist];
        newWatchlistBtn.style.display = currentUser ? 'flex' : 'none';
        actionsBtn.style.display = 'none';
      }
    }

    function updateAuthUI() {
      if (currentUser) {
        authSection.innerHTML = `
          <span class="user-info">${currentUser.email}</span>
          <button class="auth-btn secondary" onclick="logout()">Logout</button>
        `;
        loginPrompt.style.display = 'none';
      } else {
        authSection.innerHTML = `
          <button class="auth-btn" onclick="showAuthModal('login')">Login</button>
          <button class="auth-btn secondary" onclick="showAuthModal('signup')">Sign Up</button>
        `;
        if (portfolioWatchlist.length > 0 && !isPopularSelected()) {
          loginPrompt.style.display = 'inline';
        }
      }
    }

    function showAuthModal(tab = 'login') {
      authModal.classList.add('active');
      switchAuthTab(tab);
    }

    function hideAuthModal() {
      authModal.classList.remove('active');
      loginError.textContent = '';
      loginError.classList.remove('visible');
      signupError.textContent = '';
      signupError.classList.remove('visible');
      loginForm.reset();
      signupForm.reset();
    }

    function switchAuthTab(tab) {
      document.querySelectorAll('.auth-tab').forEach(t => {
        t.classList.toggle('active', t.dataset.tab === tab);
      });
      loginFormContainer.style.display = tab === 'login' ? 'block' : 'none';
      signupFormContainer.style.display = tab === 'signup' ? 'block' : 'none';
    }

    // Event Listeners
    document.querySelectorAll('.auth-tab').forEach(tab => {
      tab.addEventListener('click', () => switchAuthTab(tab.dataset.tab));
    });

    document.getElementById('modal-close').addEventListener('click', hideAuthModal);
    document.getElementById('modal-close-signup').addEventListener('click', hideAuthModal);
    document.getElementById('login-link').addEventListener('click', (e) => {
      e.preventDefault();
      showAuthModal('login');
    });

    authModal.addEventListener('click', (e) => {
      if (e.target === authModal) hideAuthModal();
    });

    // Login Form
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;
      const submitBtn = document.getElementById('login-submit');

      submitBtn.disabled = true;
      loginError.classList.remove('visible');

      try {
        const response = await fetch('/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Login failed');
        }

        authToken = data.token;
        currentUser = data.user;
        localStorage.setItem('authToken', authToken);

        // Sync local portfolio to server
        if (portfolioWatchlist.length > 0) {
          await syncLocalWatchlistToServer();
        }
        await loadServerWatchlist();

        hideAuthModal();
        updateAuthUI();
        applyActiveWatchlist();
        renderWatchlistSelector();
        renderWatchlist();
      } catch (err) {
        loginError.textContent = err.message;
        loginError.classList.add('visible');
      }

      submitBtn.disabled = false;
    });

    // Signup Form
    signupForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('signup-email').value;
      const password = document.getElementById('signup-password').value;
      const confirm = document.getElementById('signup-confirm').value;
      const submitBtn = document.getElementById('signup-submit');

      if (password !== confirm) {
        signupError.textContent = 'Passwords do not match';
        signupError.classList.add('visible');
        return;
      }

      submitBtn.disabled = true;
      signupError.classList.remove('visible');

      try {
        const response = await fetch('/api/auth/signup', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Signup failed');
        }

        authToken = data.token;
        currentUser = data.user;
        localStorage.setItem('authToken', authToken);

        // Sync local portfolio to server
        if (portfolioWatchlist.length > 0) {
          await syncLocalWatchlistToServer();
        }

        hideAuthModal();
        updateAuthUI();
        applyActiveWatchlist();
        renderWatchlistSelector();
        renderWatchlist();
      } catch (err) {
        signupError.textContent = err.message;
        signupError.classList.add('visible');
      }

      submitBtn.disabled = false;
    });

    // Add Stock Form
    addStockForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const ticker = tickerInput.value.trim().toUpperCase();
      if (!ticker) return;

      // Check if already in the current watchlist
      let currentList;
      if (isPopularSelected()) {
        currentList = popularWatchlist;
      } else if (currentUser && watchlistsData && watchlistsData.watchlists[currentWatchlistId]) {
        currentList = watchlistsData.watchlists[currentWatchlistId]?.tickers || [];
      } else {
        currentList = portfolioWatchlist;
      }

      if (currentList.includes(ticker)) {
        showToast('This stock is already in your watchlist');
        return;
      }

      const addBtn = document.getElementById('add-btn');
      addBtn.disabled = true;
      addBtn.textContent = 'Validating...';

      try {
        // Validate ticker exists by fetching price
        const validateResponse = await fetch(`/api/watchlist/prices?tickers=${ticker}`);
        const validateData = await validateResponse.json();

        if (!validateData.prices || !validateData.prices[ticker]) {
          throw new Error(`"${ticker}" is not a valid ticker symbol`);
        }

        if (isPopularSelected()) {
          // Add to Popular watchlist (saved in localStorage)
          popularWatchlist.push(ticker);
          localStorage.setItem('popularWatchlist', JSON.stringify(popularWatchlist));
          watchlist = [...popularWatchlist];
        } else if (currentUser && authToken && watchlistsData?.watchlists[currentWatchlistId]) {
          // Add to specific watchlist on server
          const response = await fetch(`/api/watchlists/${currentWatchlistId}/add`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify({ ticker })
          });

          if (!response.ok) {
            const data = await response.json();
            throw new Error(data.error || 'Failed to add stock');
          }

          // Update local watchlistsData
          if (watchlistsData?.watchlists[currentWatchlistId]) {
            watchlistsData.watchlists[currentWatchlistId].tickers.push(ticker);
          }
          watchlist = watchlistsData.watchlists[currentWatchlistId]?.tickers || [];
          renderWatchlistSelector();
        } else {
          // Not logged in - add to local portfolio list
          portfolioWatchlist.push(ticker);
          localStorage.setItem('localWatchlist', JSON.stringify(portfolioWatchlist));
          watchlist = portfolioWatchlist;
          loginPrompt.style.display = 'inline';
        }

        tickerInput.value = '';
        renderWatchlistSelector();
        renderWatchlist();
        await fetchPrices();
      } catch (err) {
        showToast(err.message);
      }

      addBtn.disabled = false;
      addBtn.textContent = 'Add';
    });

    // Remove Stock
    async function removeStock(ticker) {
      if (!confirm(`Remove ${ticker} from your watchlist?`)) return;

      try {
        if (isPopularSelected()) {
          // Remove from Popular watchlist (saved in localStorage)
          popularWatchlist = popularWatchlist.filter(t => t !== ticker);
          localStorage.setItem('popularWatchlist', JSON.stringify(popularWatchlist));
          watchlist = [...popularWatchlist];
        } else if (currentUser && authToken && watchlistsData?.watchlists[currentWatchlistId]) {
          const response = await fetch(`/api/watchlists/${currentWatchlistId}/remove/${ticker}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${authToken}` }
          });

          if (!response.ok) {
            const data = await response.json();
            throw new Error(data.error || 'Failed to remove stock');
          }

          // Update local watchlistsData
          if (watchlistsData?.watchlists[currentWatchlistId]) {
            watchlistsData.watchlists[currentWatchlistId].tickers =
              watchlistsData.watchlists[currentWatchlistId].tickers.filter(t => t !== ticker);
          }
          watchlist = watchlistsData.watchlists[currentWatchlistId]?.tickers || [];
        } else {
          portfolioWatchlist = portfolioWatchlist.filter(t => t !== ticker);
          localStorage.setItem('localWatchlist', JSON.stringify(portfolioWatchlist));
          watchlist = portfolioWatchlist;
          if (portfolioWatchlist.length === 0) {
            loginPrompt.style.display = 'none';
          }
        }

        renderWatchlistSelector();
        renderWatchlist();
      } catch (err) {
        showToast(err.message);
      }
    }

    // Logout
    async function logout() {
      authToken = null;
      currentUser = null;
      localStorage.removeItem('authToken');

      // Reset watchlist state
      portfolioWatchlist = [];
      watchlistsData = null;
      currentWatchlistId = '__popular__';
      localStorage.removeItem('localWatchlist');
      stockPerformance = {};

      applyActiveWatchlist();
      renderWatchlistSelector();
      updateAuthUI();
      renderWatchlist();
      fetchPrices();
    }

    // Load all watchlists from server
    async function loadServerWatchlist() {
      try {
        const response = await fetch('/api/watchlists', {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });

        if (response.ok) {
          const data = await response.json();
          watchlistsData = {
            defaultWatchlist: data.defaultWatchlist,
            watchlists: {}
          };
          data.watchlists.forEach(wl => {
            watchlistsData.watchlists[wl.id] = wl;
          });

          // Keep current selection if it is Popular; otherwise use server default
          if (currentWatchlistId !== '__popular__') {
            currentWatchlistId = data.defaultWatchlist;
          }

          // Clear local storage since we're using server data
          localStorage.removeItem('localWatchlist');
          portfolioWatchlist = [];

          applyActiveWatchlist();
          renderWatchlistSelector();
          await fetchPrices();
        }
      } catch (err) {
        console.error('Failed to load watchlists:', err);
        // Fallback to legacy endpoint
        try {
          const legacyResponse = await fetch('/api/watchlist', {
            headers: { 'Authorization': `Bearer ${authToken}` }
          });
          if (legacyResponse.ok) {
            const data = await legacyResponse.json();
            portfolioWatchlist = data.watchlist || [];
            localStorage.removeItem('localWatchlist');
            applyActiveWatchlist();
            await fetchPrices();
          }
        } catch (e) {
          console.error('Legacy watchlist load failed:', e);
        }
      }
    }

    // Render watchlist selector dropdown (always includes Popular first)
    function renderWatchlistSelector() {
      const select = document.getElementById('watchlist-select');

      // Always start with Popular
      let options = `<option value="__popular__" ${currentWatchlistId === '__popular__' ? 'selected' : ''}>Popular</option>`;

      if (currentUser && watchlistsData) {
        // Logged-in: add server watchlists
        Object.values(watchlistsData.watchlists).forEach(wl => {
          options += `<option value="${wl.id}" ${wl.id === currentWatchlistId ? 'selected' : ''}>${escapeHtml(wl.name)} (${wl.tickers.length})</option>`;
        });
      } else if (!currentUser) {
        // Not logged in: always show My Watchlist option so user can add stocks
        options += `<option value="__local__" ${currentWatchlistId === '__local__' ? 'selected' : ''}>My Watchlist (${portfolioWatchlist.length})</option>`;
      }

      select.innerHTML = options;
    }

    // Toast notification function
    function showToast(message, type = 'error') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      container.appendChild(toast);

      // Trigger animation
      requestAnimationFrame(() => {
        toast.classList.add('show');
      });

      // Remove after 3 seconds
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Switch watchlist (works for Popular, local, and server watchlists)
    async function switchWatchlist(watchlistId) {
      currentWatchlistId = watchlistId;
      applyActiveWatchlist();
      renderWatchlist();
      await fetchPrices();
    }

    // Handle watchlist selector change
    document.getElementById('watchlist-select').addEventListener('change', (e) => {
      switchWatchlist(e.target.value);
    });

    // Create watchlist modal functions
    function showCreateWatchlistModal() {
      if (!currentUser) {
        showAuthModal('login');
        return;
      }
      document.getElementById('create-watchlist-modal').classList.add('active');
      document.getElementById('new-watchlist-name').focus();
    }

    function hideCreateWatchlistModal() {
      document.getElementById('create-watchlist-modal').classList.remove('active');
      document.getElementById('new-watchlist-name').value = '';
    }

    // Create watchlist form handler
    document.getElementById('create-watchlist-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('new-watchlist-name').value.trim();
      if (!name) return;

      try {
        const response = await fetch('/api/watchlists', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
          },
          body: JSON.stringify({ name })
        });

        if (response.ok) {
          const data = await response.json();
          watchlistsData.watchlists[data.watchlist.id] = data.watchlist;
          currentWatchlistId = data.watchlist.id;
          watchlist = [];

          applyActiveWatchlist();
          renderWatchlistSelector();
          renderWatchlist();
          hideCreateWatchlistModal();
        } else {
          const data = await response.json();
          showToast(data.error || 'Failed to create watchlist');
        }
      } catch (err) {
        showToast('Failed to create watchlist');
      }
    });

    // Rename watchlist modal functions
    function showRenameWatchlistModal() {
      hideWatchlistActionsMenu();
      if (isPopularSelected() || !currentWatchlistId || !watchlistsData) return;

      const currentName = watchlistsData.watchlists[currentWatchlistId]?.name || '';
      document.getElementById('rename-watchlist-name').value = currentName;
      document.getElementById('rename-watchlist-modal').classList.add('active');
      document.getElementById('rename-watchlist-name').focus();
    }

    function hideRenameWatchlistModal() {
      document.getElementById('rename-watchlist-modal').classList.remove('active');
    }

    // Rename watchlist form handler
    document.getElementById('rename-watchlist-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('rename-watchlist-name').value.trim();
      if (!name || !currentWatchlistId) return;

      try {
        const response = await fetch(`/api/watchlists/${currentWatchlistId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
          },
          body: JSON.stringify({ name })
        });

        if (response.ok) {
          watchlistsData.watchlists[currentWatchlistId].name = name;
          applyActiveWatchlist();
          renderWatchlistSelector();
          hideRenameWatchlistModal();
        } else {
          const data = await response.json();
          showToast(data.error || 'Failed to rename watchlist');
        }
      } catch (err) {
        showToast('Failed to rename watchlist');
      }
    });

    // Delete current watchlist
    async function deleteCurrentWatchlist() {
      hideWatchlistActionsMenu();
      // Cannot delete Popular or non-server watchlists
      if (isPopularSelected() || !currentWatchlistId || !watchlistsData) return;

      const watchlistName = watchlistsData.watchlists[currentWatchlistId]?.name || 'this watchlist';

      if (!confirm(`Delete "${watchlistName}"? This cannot be undone.`)) return;

      try {
        const response = await fetch(`/api/watchlists/${currentWatchlistId}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${authToken}` }
        });

        if (response.ok) {
          const data = await response.json();
          delete watchlistsData.watchlists[currentWatchlistId];

          // If there are still server watchlists, switch to the default one;
          // otherwise fall back to Popular
          if (Object.keys(watchlistsData.watchlists).length > 0) {
            currentWatchlistId = data.defaultWatchlist;
          } else {
            currentWatchlistId = '__popular__';
          }

          applyActiveWatchlist();
          renderWatchlistSelector();
          renderWatchlist();
          await fetchPrices();
        } else {
          const errData = await response.json();
          showToast(errData.error || 'Failed to delete watchlist');
        }
      } catch (err) {
        showToast('Failed to delete watchlist');
      }
    }

    // Watchlist actions menu
    function showWatchlistActionsMenu() {
      const menu = document.getElementById('watchlist-actions-menu');
      const btn = document.getElementById('watchlist-actions-btn');
      const rect = btn.getBoundingClientRect();
      menu.style.top = (rect.bottom + 4) + 'px';
      menu.style.left = rect.left + 'px';
      menu.style.display = 'block';

      // Close on outside click
      setTimeout(() => {
        document.addEventListener('click', closeMenuOnOutsideClick);
      }, 0);
    }

    function hideWatchlistActionsMenu() {
      document.getElementById('watchlist-actions-menu').style.display = 'none';
      document.removeEventListener('click', closeMenuOnOutsideClick);
    }

    function closeMenuOnOutsideClick(e) {
      const menu = document.getElementById('watchlist-actions-menu');
      const btn = document.getElementById('watchlist-actions-btn');
      if (!menu.contains(e.target) && !btn.contains(e.target)) {
        hideWatchlistActionsMenu();
      }
    }

    // Sync local watchlist to server
    async function syncLocalWatchlistToServer() {
      for (const ticker of portfolioWatchlist) {
        try {
          await fetch('/api/watchlist/add', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify({ ticker })
          });
        } catch (err) {
          console.error(`Failed to sync ${ticker}:`, err);
        }
      }
      // Clear local storage after syncing
      localStorage.removeItem('localWatchlist');
      portfolioWatchlist = [];
    }

    // Fetch performance data (multi-timeframe)
    async function fetchPrices() {
      if (watchlist.length === 0) return;

      try {
        const response = await fetch(`/api/watchlist/performance?tickers=${watchlist.join(',')}`);
        if (response.ok) {
          const data = await response.json();
          stockPerformance = data.performance || {};
          lastUpdated.textContent = `Updated ${new Date().toLocaleTimeString()}`;
          renderWatchlist();
        }
      } catch (err) {
        console.error('Failed to fetch performance:', err);
      }
    }

    // Format a percentage change for display
    function formatChange(value) {
      if (value == null) return { text: '--', className: 'neutral' };
      const sign = value >= 0 ? '+' : '';
      const text = `${sign}${value.toFixed(1)}%`;
      const className = value > 0 ? 'positive' : value < 0 ? 'negative' : 'neutral';
      return { text, className };
    }

    // Sort the watchlist tickers based on current sort settings
    function getSortedWatchlist() {
      // Make a copy so we don't mutate the original array
      const sorted = [...watchlist];

      sorted.sort((a, b) => {
        const perfA = stockPerformance[a];
        const perfB = stockPerformance[b];

        let valA, valB;

        if (currentSortKey === 'name') {
          valA = (perfA?.companyName || a).toLowerCase();
          valB = (perfB?.companyName || b).toLowerCase();
          const cmp = valA.localeCompare(valB);
          return currentSortDir === 'asc' ? cmp : -cmp;
        }

        if (currentSortKey === 'price') {
          valA = perfA?.price ?? -Infinity;
          valB = perfB?.price ?? -Infinity;
        } else {
          // Timeframe keys: '1D', '5D', '1M', 'YTD', '1Y'
          valA = perfA?.[currentSortKey] ?? -Infinity;
          valB = perfB?.[currentSortKey] ?? -Infinity;
        }

        const diff = valA - valB;
        return currentSortDir === 'asc' ? diff : -diff;
      });

      return sorted;
    }

    // Handle column header sort click
    function handleSortClick(key) {
      if (currentSortKey === key) {
        // Toggle direction
        currentSortDir = currentSortDir === 'desc' ? 'asc' : 'desc';
      } else {
        currentSortKey = key;
        // Default directions: name -> asc, everything else -> desc
        currentSortDir = key === 'name' ? 'asc' : 'desc';
      }
      renderWatchlist();
    }

    // Build a sortable column header
    function buildColHeader(key, label, isRight) {
      const isActive = currentSortKey === key;
      const arrow = isActive ? `<span class="sort-arrow">${currentSortDir === 'desc' ? '\u25BC' : '\u25B2'}</span>` : '';
      const classes = `col-header sortable${isRight ? ' right' : ''}${isActive ? ' active' : ''}`;
      return `<span class="${classes}" onclick="handleSortClick('${key}')">${label}${arrow}</span>`;
    }

    // Render watchlist
    function renderWatchlist() {
      if (watchlist.length === 0) {
        watchlistContainer.innerHTML = `
          <div class="empty-state">
            <h3>Your watchlist is empty</h3>
            <p>Add stocks above to start tracking them.</p>
          </div>
        `;
        return;
      }

      const timeframes = ['1D', '5D', '1M', 'YTD', '1Y'];
      const gridCols = '80px 1fr 90px 68px 68px 68px 68px 68px 40px';
      const sortedTickers = getSortedWatchlist();

      let html = `
        <div class="stock-table-header" style="grid-template-columns: ${gridCols};">
          <span class="col-header">Ticker</span>
          ${buildColHeader('name', 'Name', false)}
          ${buildColHeader('price', 'Price', true)}
          ${timeframes.map(tf => buildColHeader(tf, tf, true)).join('')}
          <span class="col-header"></span>
        </div>
      `;

      for (const ticker of sortedTickers) {
        const perf = stockPerformance[ticker];
        const priceDisplay = perf ? `$${perf.price.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}` : '--';
        const companyName = perf?.companyName || ticker;
        const changePercent = perf?.['1D'] || 0;
        const escapedCompanyName = escapeHtml(companyName).replace(/'/g, "\\'");

        let changeColumns = '';
        for (const tf of timeframes) {
          const val = perf ? perf[tf] : null;
          const { text, className } = formatChange(val);
          changeColumns += `<span class="stock-change ${className}">${text}</span>`;
        }

        const removeBtn = `
            <button class="remove-btn" onclick="event.stopPropagation(); removeStock('${ticker}')" title="Remove">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>`;

        html += `
          <div class="stock-row" style="grid-template-columns: ${gridCols};" onclick="openStockPanel('${ticker}', '${escapedCompanyName}', ${changePercent})">
            <span class="stock-ticker">${ticker}</span>
            <span class="stock-name">${escapeHtml(companyName)}</span>
            <span class="stock-price">${priceDisplay}</span>
            ${changeColumns}
            ${removeBtn}
          </div>
        `;
      }

      watchlistContainer.innerHTML = html;
    }

    // Auto-refresh
    function startAutoRefresh() {
      // Initial fetch
      if (watchlist.length > 0) {
        fetchPrices();
      }

      // Refresh every 15 minutes
      refreshInterval = setInterval(() => {
        if (watchlist.length > 0) {
          fetchPrices();
        }
      }, 900000);
    }

    // Manual refresh
    refreshBtn.addEventListener('click', () => {
      if (watchlist.length > 0) {
        fetchPrices();
      }
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      if (refreshInterval) {
        clearInterval(refreshInterval);
      }
    });

    // Google Sign-In Initialization
    // This function is called when the Google Identity Services script loads
    function initializeGoogleSignIn() {
      if (typeof google === 'undefined' || !google.accounts) {
        // Google script not loaded yet, retry after a delay
        setTimeout(initializeGoogleSignIn, 100);
        return;
      }

      if (googleInitialized) return;
      googleInitialized = true;

      // Initialize Google Sign-In
      google.accounts.id.initialize({
        client_id: GOOGLE_CLIENT_ID,
        callback: handleGoogleCredentialResponse,
        auto_select: false,
        cancel_on_tap_outside: true
      });

      // Render Google Sign-In button in login form
      const loginBtnContainer = document.getElementById('google-signin-btn-login');
      if (loginBtnContainer) {
        google.accounts.id.renderButton(
          loginBtnContainer,
          {
            type: 'standard',
            theme: 'outline',
            size: 'large',
            text: 'signin_with',
            shape: 'rectangular',
            logo_alignment: 'left',
            width: 352
          }
        );
      }

      // Render Google Sign-In button in signup form
      const signupBtnContainer = document.getElementById('google-signin-btn-signup');
      if (signupBtnContainer) {
        google.accounts.id.renderButton(
          signupBtnContainer,
          {
            type: 'standard',
            theme: 'outline',
            size: 'large',
            text: 'signup_with',
            shape: 'rectangular',
            logo_alignment: 'left',
            width: 352
          }
        );
      }
    }

    // Handle Google credential response
    async function handleGoogleCredentialResponse(response) {
      try {
        // Send the ID token to our backend for verification
        const backendResponse = await fetch('/api/auth/google', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ credential: response.credential })
        });

        const data = await backendResponse.json();

        if (!backendResponse.ok) {
          throw new Error(data.error || 'Google sign-in failed');
        }

        // Success - store token and user info
        authToken = data.token;
        currentUser = data.user;
        localStorage.setItem('authToken', authToken);

        // Sync local portfolio to server if user had local items
        if (portfolioWatchlist.length > 0) {
          await syncLocalWatchlistToServer();
        }
        await loadServerWatchlist();

        hideAuthModal();
        updateAuthUI();
        applyActiveWatchlist();
        renderWatchlistSelector();
        renderWatchlist();

        console.log('Google sign-in successful:', currentUser.email);
      } catch (err) {
        console.error('Google sign-in error:', err);
        // Show error in the currently visible form
        const visibleError = loginFormContainer.style.display !== 'none' ? loginError : signupError;
        visibleError.textContent = err.message;
        visibleError.classList.add('visible');
      }
    }

    // Initialize Google Sign-In when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeGoogleSignIn);
    } else {
      initializeGoogleSignIn();
    }

    // ========================================
    // Side Panel / Stock Chart Functions
    // ========================================
    let currentPanelTicker = null;
    let currentPanelRange = '1d';

    function chartFormatPrice(price) {
      if (price == null) return '--';
      return price.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function openStockPanel(ticker, companyName, changePercent) {
      currentPanelTicker = ticker;
      currentPanelRange = '1d';

      const panelOverlay = document.getElementById('panel-overlay');
      const sidePanel = document.getElementById('side-panel');
      const panelContent = document.getElementById('panel-content');
      const panelTitle = document.getElementById('panel-title');
      const panelTicker = document.getElementById('panel-ticker');

      const change = parseFloat(changePercent);
      const isPositive = change >= 0;

      // Look up the stock from stockPerformance to get price and compute dollar change
      let stockPrice = null;
      let stockChangeDollar = null;
      const perf = stockPerformance[ticker];
      if (perf) {
        if (perf.price != null) stockPrice = perf.price;
        // Compute dollar change from price and percentage: price = prevClose * (1 + pct/100)
        // so changeDollar = price - prevClose = price - price/(1 + pct/100) = price * pct / (100 + pct)
        if (perf.price != null && change !== 0) {
          stockChangeDollar = perf.price * change / (100 + change);
        } else if (change === 0) {
          stockChangeDollar = 0;
        }
      }

      // Set the header info
      panelTitle.textContent = companyName;
      panelTicker.textContent = ticker;

      // Build price display HTML (Google Finance style)
      let priceHtml = '';
      if (stockPrice != null) {
        const sign = isPositive ? '+' : '-';
        const dollarPart = stockChangeDollar != null ? `${sign}$${Math.abs(stockChangeDollar).toFixed(2)} ` : '';
        const pctPart = `(${isPositive ? '+' : ''}${change.toFixed(2)}%)`;
        const now = new Date();
        const dateStr = now.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) + ', ' +
          now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true, timeZoneName: 'short' });
        priceHtml = `
          <div class="panel-price-display">
            <span class="panel-price-value">$${stockPrice.toFixed(2)}</span>
            <span class="panel-price-change ${isPositive ? 'positive' : 'negative'}">${dollarPart}${pctPart} today</span>
            <span class="panel-price-date">${dateStr}</span>
          </div>
        `;
      }

      // Set up panel content with price, chart, and analysis containers
      panelContent.innerHTML = `
        ${priceHtml}
        <div class="chart-timeframe-tabs" id="chart-tabs">
          ${['1D','5D','1M','3M','6M','YTD','1Y'].map(t =>
            `<button class="chart-tab${t === '1D' ? ' active' : ''}" data-range="${t.toLowerCase()}">${t}</button>`
          ).join('')}
        </div>
        <div class="chart-container" id="chart-container">
          <div class="chart-loading"><div class="spinner"></div>Loading chart...</div>
        </div>
        <div id="analysis-container">
          <div class="panel-section">
            <h2 class="section-title">Analysis</h2>
            <div class="panel-status">
              <div class="spinner"></div>
              <span>Generating analysis...</span>
            </div>
          </div>
        </div>
      `;

      panelOverlay.classList.add('active');
      sidePanel.classList.add('active');
      document.body.style.overflow = 'hidden';

      // Attach tab click handlers
      document.querySelectorAll('#chart-tabs .chart-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          const range = tab.dataset.range;
          if (range === currentPanelRange) return;
          currentPanelRange = range;
          document.querySelectorAll('#chart-tabs .chart-tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          loadChartData(currentPanelTicker, range);
        });
      });

      // Fetch chart data and AI analysis in parallel
      loadChartData(ticker, '1d');
      fetchStockExplanation(ticker, companyName, changePercent);
    }

    async function loadChartData(ticker, range) {
      const chartContainer = document.getElementById('chart-container');
      if (!chartContainer) return;
      chartContainer.innerHTML = `<div class="chart-loading"><div class="spinner"></div>Loading chart...</div>`;

      try {
        // Map 3m to 6m range on backend (no native 3m), we'll trim client-side
        const apiRange = range === '3m' ? '6m' : range;
        const response = await fetch(`/api/stock-chart?ticker=${encodeURIComponent(ticker)}&range=${apiRange}`);
        if (!response.ok) throw new Error('Failed to load chart');

        const data = await response.json();
        let chartPoints = data.chart;

        // For 3m, trim 6m data to last ~3 months
        if (range === '3m' && chartPoints && chartPoints.length > 0) {
          const threeMonthsAgo = Date.now() - (90 * 24 * 60 * 60 * 1000);
          chartPoints = chartPoints.filter(p => p.timestamp >= threeMonthsAgo);
        }

        // If 1D has no chart data (e.g. weekend/holiday), fall back to 5D
        if (range === '1d' && (!chartPoints || chartPoints.length === 0)) {
          return loadChartData(ticker, '5d');
        }

        renderSVGChart(chartPoints, data.quote, range);
      } catch (err) {
        console.error('Chart load error:', err);
        chartContainer.innerHTML = `<div class="chart-loading" style="color:#c5221f;">Failed to load chart data</div>`;
      }
    }

    function renderSVGChart(points, quote, range) {
      const container = document.getElementById('chart-container');
      if (!points || points.length < 2) {
        container.innerHTML = `<div class="chart-loading" style="color:#5f6368;">No chart data available</div>`;
        return;
      }

      const width = 430;
      const height = 180;
      const padLeft = 0;
      const padRight = 60;
      const padTop = 8;
      const padBottom = 24;
      const chartW = width - padLeft - padRight;
      const chartH = height - padTop - padBottom;

      const prices = points.map(p => p.price);
      let minPrice = Math.min(...prices);
      let maxPrice = Math.max(...prices);

      // Include previous close in range for 1D view
      const prevClose = quote.previousClose;
      if (range === '1d' && prevClose != null) {
        minPrice = Math.min(minPrice, prevClose);
        maxPrice = Math.max(maxPrice, prevClose);
      }

      // Add small padding to price range
      const priceRange = maxPrice - minPrice || 1;
      minPrice -= priceRange * 0.05;
      maxPrice += priceRange * 0.05;
      const finalRange = maxPrice - minPrice;

      const firstPrice = range === '1d' && prevClose != null ? prevClose : points[0].price;
      const lastPrice = points[points.length - 1].price;
      const isUp = lastPrice >= firstPrice;
      const lineColor = isUp ? '#137333' : '#c5221f';
      const fillColor = isUp ? 'rgba(19,115,51,0.08)' : 'rgba(197,34,31,0.08)';

      // Scale functions
      const xScale = (i) => padLeft + (i / (points.length - 1)) * chartW;
      const yScale = (price) => padTop + ((maxPrice - price) / finalRange) * chartH;

      // Build line path
      let linePath = `M ${xScale(0)} ${yScale(points[0].price)}`;
      for (let i = 1; i < points.length; i++) {
        linePath += ` L ${xScale(i)} ${yScale(points[i].price)}`;
      }

      // Build fill path (area under line)
      let fillPath = linePath;
      fillPath += ` L ${xScale(points.length - 1)} ${padTop + chartH}`;
      fillPath += ` L ${xScale(0)} ${padTop + chartH} Z`;

      // Y-axis labels (4 ticks for compact view)
      let yLabels = '';
      let gridLines = '';
      const numTicks = 4;
      for (let i = 0; i <= numTicks; i++) {
        const price = maxPrice - (i / numTicks) * finalRange;
        const y = padTop + (i / numTicks) * chartH;
        yLabels += `<text x="${width - padRight + 6}" y="${y + 4}" font-size="9" fill="#5f6368" font-family="Arial, sans-serif">${chartFormatPrice(price)}</text>`;
        gridLines += `<line x1="${padLeft}" y1="${y}" x2="${width - padRight}" y2="${y}" stroke="#f0f0f0" stroke-width="1"/>`;
      }

      // X-axis labels
      let xLabels = '';
      const numXLabels = 4;
      for (let i = 0; i <= numXLabels; i++) {
        const idx = Math.round((i / numXLabels) * (points.length - 1));
        const x = xScale(idx);
        const ts = points[idx].timestamp;
        const d = new Date(ts);
        let label;
        if (range === '1d') {
          label = d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
        } else if (range === '5d') {
          label = d.toLocaleDateString('en-US', { weekday: 'short' });
        } else if (range === '1m' || range === '3m' || range === '6m' || range === 'ytd') {
          label = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        } else {
          label = d.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
        }
        xLabels += `<text x="${x}" y="${height - 4}" font-size="9" fill="#5f6368" text-anchor="middle" font-family="Arial, sans-serif">${label}</text>`;
      }

      // Previous close line (only for 1D)
      let prevCloseLine = '';
      if (range === '1d' && prevClose != null) {
        const pcY = yScale(prevClose);
        prevCloseLine = `
          <line x1="${padLeft}" y1="${pcY}" x2="${width - padRight}" y2="${pcY}" stroke="#9aa0a6" stroke-width="1" stroke-dasharray="4,3"/>
        `;
      }

      const svgId = 'panel-chart-svg';
      const tooltipId = 'panel-chart-tooltip';

      container.innerHTML = `
        <svg id="${svgId}" viewBox="0 0 ${width} ${height}" preserveAspectRatio="xMidYMid meet">
          ${gridLines}
          ${prevCloseLine}
          <path d="${fillPath}" fill="${fillColor}"/>
          <path d="${linePath}" fill="none" stroke="${lineColor}" stroke-width="2" stroke-linejoin="round" stroke-linecap="round"/>
          ${yLabels}
          ${xLabels}
          <line id="panel-chart-crosshair" x1="0" y1="${padTop}" x2="0" y2="${padTop + chartH}" stroke="#dadce0" stroke-width="1" visibility="hidden"/>
          <circle id="panel-chart-dot" cx="0" cy="0" r="3.5" fill="${lineColor}" stroke="white" stroke-width="1.5" visibility="hidden"/>
          <rect id="panel-chart-hover" x="${padLeft}" y="${padTop}" width="${chartW}" height="${chartH}" fill="transparent" cursor="crosshair"/>
        </svg>
        <div class="chart-tooltip" id="${tooltipId}"></div>
      `;

      // Add hover interactivity
      const svg = document.getElementById(svgId);
      const hoverArea = document.getElementById('panel-chart-hover');
      const crosshair = document.getElementById('panel-chart-crosshair');
      const dot = document.getElementById('panel-chart-dot');
      const tooltip = document.getElementById(tooltipId);

      function handleHover(e) {
        const rect = svg.getBoundingClientRect();
        const svgX = ((e.clientX - rect.left) / rect.width) * width;
        const relX = svgX - padLeft;
        const idx = Math.round((relX / chartW) * (points.length - 1));
        if (idx < 0 || idx >= points.length) return;

        const px = xScale(idx);
        const py = yScale(points[idx].price);

        crosshair.setAttribute('x1', px);
        crosshair.setAttribute('x2', px);
        crosshair.setAttribute('visibility', 'visible');
        dot.setAttribute('cx', px);
        dot.setAttribute('cy', py);
        dot.setAttribute('visibility', 'visible');

        const d = new Date(points[idx].timestamp);
        let timeStr;
        if (range === '1d' || range === '5d') {
          timeStr = d.toLocaleString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true });
        } else {
          timeStr = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        tooltip.textContent = `$${chartFormatPrice(points[idx].price)}  ${timeStr}`;
        tooltip.classList.add('visible');

        // Position tooltip
        const containerRect = container.getBoundingClientRect();
        const tooltipX = (px / width) * containerRect.width;
        const tooltipY = (py / height) * containerRect.height;
        tooltip.style.left = Math.min(tooltipX - tooltip.offsetWidth / 2, containerRect.width - tooltip.offsetWidth - 4) + 'px';
        tooltip.style.top = (tooltipY - 36) + 'px';
      }

      hoverArea.addEventListener('mousemove', handleHover);
      hoverArea.addEventListener('mouseleave', () => {
        crosshair.setAttribute('visibility', 'hidden');
        dot.setAttribute('visibility', 'hidden');
        tooltip.classList.remove('visible');
      });
    }

    function renderAnalysis(analysisText) {
      // Convert **bold** markdown to <strong> tags
      const withBold = analysisText.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');

      // Split into paragraphs
      const paragraphs = withBold.split('\n\n').filter(p => p.trim());

      // Render as flowing paragraphs under a single "Analysis" header
      return `
        <div class="panel-section">
          <h2 class="section-title">Analysis</h2>
          <div class="section-content">
            ${paragraphs.map(p => `<p>${p.trim()}</p>`).join('')}
          </div>
        </div>
      `;
    }

    async function fetchStockExplanation(ticker, companyName, changePercent) {
      const analysisContainer = document.getElementById('analysis-container');
      if (!analysisContainer) return;

      try {
        const params = new URLSearchParams({ ticker, companyName, changePercent });
        const response = await fetch(`/api/stock-explanation-details?${params}`);
        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.isQuotaError ? 'quota' : (data.error || 'Failed to load analysis'));
        }

        analysisContainer.innerHTML = renderAnalysis(data.analysis);
      } catch (error) {
        console.error('Error fetching stock explanation:', error);
        let errorMsg = 'Unable to load detailed analysis. Please try again.';
        if (error.message === 'quota') {
          errorMsg = 'AI service quota exceeded. This feature will be available again soon. Please try again later.';
        }
        analysisContainer.innerHTML = `
          <div class="panel-error">
            <p>${errorMsg}</p>
          </div>
        `;
      }
    }

    function closePanel() {
      const panelOverlay = document.getElementById('panel-overlay');
      const sidePanel = document.getElementById('side-panel');
      panelOverlay.classList.remove('active');
      sidePanel.classList.remove('active');
      document.body.style.overflow = '';
      currentPanelTicker = null;
    }

    document.addEventListener('click', function(e) {
      if (e.target.id === 'panel-overlay') {
        closePanel();
      }
    });

    document.addEventListener('keydown', function(e) {
      const sidePanel = document.getElementById('side-panel');
      if (e.key === 'Escape' && sidePanel && sidePanel.classList.contains('active')) {
        closePanel();
      }
    });
  </script>

  <!-- Side Panel Overlay -->
  <div class="panel-overlay" id="panel-overlay"></div>

  <!-- Stock Explanation Details Side Panel -->
  <div class="side-panel" id="side-panel">
    <div class="panel-header">
      <button class="panel-close-button" onclick="closePanel()" aria-label="Close panel">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
      <div class="panel-label">Stock Analysis</div>
      <h1 class="panel-title" id="panel-title">Loading...</h1>
      <div class="panel-ticker" id="panel-ticker"></div>
    </div>

    <div class="panel-content" id="panel-content">
      <!-- Content will be dynamically inserted -->
    </div>

    <div class="panel-footer">
      <button class="panel-footer-btn" onclick="closePanel()">Close</button>
    </div>
  </div>

  <!-- Bottom Tab Bar (Mobile) -->
  <nav class="bottom-tab-bar">
    <div class="tab-items">
      <a href="/market" class="tab-item">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"/></svg>
        <span class="tab-label">Market</span>
      </a>
      <a href="/top-movers" class="tab-item">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>
        <span class="tab-label">Top Movers</span>
      </a>
      <a href="/portfolio" class="tab-item active">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/></svg>
        <span class="tab-label">Portfolio</span>
      </a>
      <a href="/ideageneration" class="tab-item">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>
        <span class="tab-label">Ideas</span>
      </a>
      <a href="/index.html" class="tab-item">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
        <span class="tab-label">Initiation</span>
      </a>
    </div>
  </nav>

  <script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js');
  }
  </script>
</body>
</html>
