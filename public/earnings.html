<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Earnings Review</title>
  <style>
    /* ===== Reset & Base ===== */
    * { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      /* Brand */
      --brand-dark: #1e3a5f;
      --brand-mid: #2d5a87;
      --brand-light: #e8f0f7;

      /* Positive / Negative */
      --positive: #137333;
      --positive-bg: #e6f4ea;
      --negative: #c5221f;
      --negative-bg: #fce8e6;

      /* Neutrals */
      --text-primary: #1a1d21;
      --text-secondary: #5f6368;
      --text-tertiary: #80868b;
      --text-faint: #9aa0a6;

      --bg-page: #f5f6f8;
      --bg-card: #ffffff;
      --bg-subtle: #f8f9fa;

      --border: #e2e5e9;

      /* Sizing */
      --radius-card: 10px;
      --radius-sm: 6px;
      --shadow-card: 0 1px 3px rgba(0, 0, 0, 0.08);
      --shadow-hover: 0 4px 12px rgba(0, 0, 0, 0.12);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg-page);
      color: var(--text-primary);
      line-height: 1.7;
      -webkit-font-smoothing: antialiased;
    }

    /* ===== Navigation Banner ===== */
    .nav-strip {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 48px;
      background: var(--bg-card);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      padding: 0 24px;
      z-index: 1000;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
      color: var(--text-primary);
      margin-right: 24px;
      flex-shrink: 0;
    }

    .brand-ic {
      font-size: 16px;
      font-weight: 800;
      color: var(--brand-dark);
      letter-spacing: -1px;
    }

    .brand-sep {
      width: 1px;
      height: 20px;
      background: var(--border);
    }

    .nav-tabs {
      display: flex;
      align-items: stretch;
      height: 48px;
      gap: 0;
    }

    .nav-tab {
      text-decoration: none;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-tertiary);
      padding: 0 16px;
      display: flex;
      align-items: center;
      border-bottom: 2px solid transparent;
      transition: all 0.15s ease;
      white-space: nowrap;
    }

    .nav-tab:hover {
      color: var(--text-secondary);
    }

    .nav-tab.active {
      color: var(--brand-dark);
      border-bottom-color: var(--brand-dark);
      font-weight: 600;
    }

    @media (max-width: 900px) {
      .nav-tab {
        padding: 0 10px;
        font-size: 12px;
      }
    }

    @media (max-width: 480px) {
      .nav-tab {
        padding: 0 7px;
        font-size: 11px;
      }
      .brand-sep { display: none; }
    }

    /* ===== Bottom Tab Bar (Mobile) ===== */
    .bottom-tab-bar {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--brand-dark);
      z-index: 1000;
      padding-bottom: env(safe-area-inset-bottom);
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.15);
    }

    .bottom-tab-bar .tab-items {
      display: flex;
      justify-content: space-around;
      align-items: center;
      height: 56px;
    }

    .bottom-tab-bar .tab-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-decoration: none;
      color: rgba(255, 255, 255, 0.6);
      font-size: 9px;
      font-weight: 500;
      gap: 3px;
      padding: 6px 4px;
      min-width: 0;
      flex: 1;
      -webkit-tap-highlight-color: transparent;
      transition: color 0.2s;
    }

    .bottom-tab-bar .tab-item.active {
      color: white;
    }

    .bottom-tab-bar .tab-item svg {
      width: 22px;
      height: 22px;
    }

    .bottom-tab-bar .tab-label {
      line-height: 1;
    }

    /* ===== Report Wrapper ===== */
    .report-wrapper {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
      padding-top: 76px;
    }
    .report-toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .toolbar-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .back-link {
      color: var(--brand-dark);
      text-decoration: none;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .back-link:hover {
      text-decoration: underline;
    }

    /* ===== Loading ===== */
    .loading-container {
      text-align: center;
      padding: 100px 20px;
      background: var(--bg-card);
      box-shadow: var(--shadow-card);
      border-radius: var(--radius-card);
    }
    .loading-title {
      font-size: 18px;
      margin-bottom: 30px;
      color: var(--text-primary);
    }
    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border);
      border-top-color: var(--brand-dark);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 20px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .loading-time {
      font-size: 14px;
      color: var(--text-faint);
    }
    .error {
      color: var(--negative);
      text-align: center;
      padding: 40px;
    }

    /* ===== Report Page ===== */
    .page {
      background: var(--bg-card);
      padding: 48px 56px;
      box-shadow: var(--shadow-card);
      border-radius: var(--radius-card);
      display: none;
    }
    .page.visible {
      display: block;
    }

    /* Header */
    .report-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      border-bottom: 3px solid var(--brand-dark);
      padding-bottom: 20px;
      margin-bottom: 28px;
    }
    .header-left {
      flex: 1;
    }
    .report-type {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 2px;
      color: var(--brand-dark);
      margin-bottom: 10px;
      font-weight: 600;
    }
    .company-name {
      font-size: 38px;
      font-weight: bold;
      color: var(--brand-dark);
      margin-bottom: 4px;
    }
    .ticker-info {
      font-size: 13px;
      color: var(--text-secondary);
    }
    .header-right {
      text-align: right;
    }
    .price-move-badge {
      display: inline-block;
      padding: 12px 24px;
      font-size: 24px;
      font-weight: 700;
      border-radius: var(--radius-sm);
      margin-top: 8px;
      font-variant-numeric: tabular-nums;
    }
    .price-move-badge.positive {
      background: var(--positive-bg);
      color: var(--positive);
    }
    .price-move-badge.negative {
      background: var(--negative-bg);
      color: var(--negative);
    }
    .price-move-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }

    /* Section Headers */
    .page h2 {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: var(--brand-dark);
      border-bottom: 1px solid var(--border);
      padding-bottom: 8px;
      margin-top: 32px;
      margin-bottom: 16px;
    }
    .page h2:first-of-type {
      margin-top: 0;
    }

    /* Sub-section Headers */
    .page h3 {
      font-size: 16px;
      font-weight: 600;
      color: var(--brand-dark);
      margin-top: 24px;
      margin-bottom: 12px;
    }

    /* Body Text */
    .page p {
      margin-bottom: 14px;
      text-align: justify;
      font-size: 15px;
    }

    /* Lists */
    .page ul, .page ol {
      margin: 14px 0 14px 24px;
      font-size: 15px;
    }
    .page li {
      margin-bottom: 10px;
      line-height: 1.6;
    }

    /* Key Insight Box */
    .insight-box {
      background: var(--brand-light);
      border-left: 4px solid var(--brand-dark);
      padding: 16px 20px;
      margin: 24px 0;
      border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
    }
    .insight-label {
      font-size: 9px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--brand-dark);
      font-weight: 600;
      margin-bottom: 8px;
    }
    .insight-text {
      font-style: italic;
      color: var(--text-secondary);
      font-size: 15px;
    }

    /* Headline Box */
    .headline-box {
      background: var(--brand-dark);
      color: white;
      padding: 20px 24px;
      margin-bottom: 28px;
      border-radius: var(--radius-sm);
    }
    .headline-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 2px;
      opacity: 0.8;
      margin-bottom: 8px;
    }
    .headline-text {
      font-size: 18px;
      line-height: 1.5;
      font-weight: 500;
    }

    /* Key Debates Section */
    .debates-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin: 20px 0;
    }
    .debate-case {
      padding: 20px;
      border-radius: var(--radius-sm);
    }
    .bull-case-box {
      background: var(--positive-bg);
      border-left: 4px solid var(--positive);
    }
    .bear-case-box {
      background: var(--negative-bg);
      border-left: 4px solid var(--negative);
    }
    .case-header {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 600;
      margin-bottom: 12px;
    }
    .bull-case-box .case-header {
      color: var(--positive);
    }
    .bear-case-box .case-header {
      color: var(--negative);
    }
    .case-points {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .case-points li {
      margin-bottom: 10px;
      padding-left: 16px;
      position: relative;
      font-size: 14px;
      line-height: 1.5;
    }
    .bull-case-box .case-points li::before {
      content: "+";
      position: absolute;
      left: 0;
      color: var(--positive);
      font-weight: bold;
    }
    .bear-case-box .case-points li::before {
      content: "-";
      position: absolute;
      left: 0;
      color: var(--negative);
      font-weight: bold;
    }

    /* Management Q&A Section */
    .qa-section {
      margin-top: 32px;
    }
    .qa-item {
      margin: 16px 0;
      padding: 16px 20px;
      background: var(--bg-subtle);
      border-left: 3px solid var(--brand-dark);
      border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
    }
    .qa-analyst {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-secondary);
      margin-bottom: 6px;
    }
    .qa-question {
      font-weight: 600;
      color: var(--brand-dark);
      margin-bottom: 10px;
      font-size: 14px;
      line-height: 1.5;
    }
    .qa-answer {
      color: var(--text-secondary);
      font-size: 14px;
      line-height: 1.6;
    }
    .qa-answer::before {
      content: "A: ";
      font-weight: 600;
      color: var(--brand-dark);
    }

    @media (max-width: 768px) {
      .debates-container {
        grid-template-columns: 1fr;
      }
    }

    /* Content Sections */
    .review-section {
      margin-bottom: 28px;
    }
    .review-section:last-child {
      margin-bottom: 0;
    }

    /* Strong text */
    .page strong {
      color: var(--text-primary);
      font-weight: 600;
    }

    /* Meta info */
    .meta-info {
      font-size: 12px;
      color: var(--text-faint);
      margin-top: 32px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }

    /* ===== Responsive ===== */
    @media (max-width: 768px) {
      .nav-strip {
        display: none;
      }

      .bottom-tab-bar {
        display: block;
      }

      body {
        padding-top: env(safe-area-inset-top);
        padding-bottom: calc(56px + env(safe-area-inset-bottom));
      }

      .report-wrapper {
        padding: 16px;
        padding-top: calc(24px + env(safe-area-inset-top));
      }
      .page {
        padding: 24px;
      }
      .company-name {
        font-size: 28px;
      }
      .price-move-badge {
        font-size: 18px;
        padding: 8px 16px;
      }
      .report-header {
        flex-direction: column;
        gap: 16px;
      }
      .header-right {
        text-align: left;
      }
    }
  </style>
</head>
<body>
  <nav class="nav-strip">
    <a href="/market" class="brand">
      <span class="brand-ic">IC</span>
    </a>
    <div class="brand-sep"></div>
    <div class="nav-tabs">
      <a href="/market" class="nav-tab">Market Update</a>
      <a href="/top-movers" class="nav-tab">Top Movers</a>
      <a href="/portfolio" class="nav-tab">Portfolio</a>
      <a href="/ideageneration" class="nav-tab">Idea Generation</a>
      <a href="/index.html" class="nav-tab">Initiation</a>
    </div>
  </nav>

  <div class="report-wrapper">
    <div class="report-toolbar">
      <div class="toolbar-left">
        <a href="#" class="back-link" id="back-link">&#8592; Back</a>
      </div>
    </div>

    <div class="loading-container" id="loading">
      <div class="loading-title">Loading Earnings Review for <strong id="loading-ticker"></strong></div>
      <div class="spinner"></div>
      <div class="loading-time">Generating... <span id="loading-timer">0:00</span></div>
    </div>

    <div class="page" id="report-page"></div>
  </div>

  <!-- Bottom Tab Bar (Mobile) -->
  <nav class="bottom-tab-bar">
    <div class="tab-items">
      <a href="/market" class="tab-item">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"/></svg>
        <span class="tab-label">Market</span>
      </a>
      <a href="/top-movers" class="tab-item">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>
        <span class="tab-label">Top Movers</span>
      </a>
      <a href="/portfolio" class="tab-item">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/></svg>
        <span class="tab-label">Portfolio</span>
      </a>
      <a href="/ideageneration" class="tab-item">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>
        <span class="tab-label">Ideas</span>
      </a>
      <a href="/index.html" class="tab-item">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
        <span class="tab-label">Initiation</span>
      </a>
    </div>
  </nav>

  <script>
    // Get ticker from URL path (clean URL) or query parameters (legacy)
    const urlParams = new URLSearchParams(window.location.search);
    let ticker = urlParams.get('ticker');
    let priceMove = urlParams.get('priceMove') || '+0%';

    // Check for clean URL format: /pltr-earnings
    const pathMatch = window.location.pathname.match(/^\/([a-zA-Z]+)-earnings$/i);
    if (pathMatch) {
      ticker = pathMatch[1].toUpperCase();
    }

    // Set up back link based on referrer
    const backLink = document.getElementById('back-link');
    if (document.referrer) {
      backLink.href = document.referrer;
    } else if (urlParams.get('from') === 'market') {
      backLink.href = '/market.html';
    } else {
      backLink.href = '/top-movers';
    }

    // Update loading ticker
    const loadingTicker = document.getElementById('loading-ticker');
    if (ticker) {
      loadingTicker.textContent = ticker.toUpperCase();
      document.title = `${ticker.toUpperCase()} Earnings Review`;
    }

    // Elements
    const loadingEl = document.getElementById('loading');
    const reportPage = document.getElementById('report-page');

    // Timer variables
    let loadingTimer = null;
    let loadingStartTime = null;

    function startLoadingTimer() {
      loadingStartTime = Date.now();
      const timerEl = document.getElementById('loading-timer');

      loadingTimer = setInterval(() => {
        const elapsed = Math.floor((Date.now() - loadingStartTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        timerEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
      }, 1000);
    }

    function stopLoadingTimer() {
      if (loadingTimer) {
        clearInterval(loadingTimer);
        loadingTimer = null;
      }
    }

    // Fetch and display earnings review
    async function loadEarningsReview() {
      if (!ticker) {
        loadingEl.innerHTML = '<div class="error">No ticker specified. Please provide a ticker parameter.</div>';
        return;
      }

      // Start the timer
      startLoadingTimer();

      try {
        const response = await fetch(`/api/earnings-review/${ticker}?priceMove=${encodeURIComponent(priceMove)}`);

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Failed to fetch earnings review');
        }

        const data = await response.json();
        renderReport(data);

      } catch (error) {
        console.error('Error fetching earnings review:', error);
        stopLoadingTimer();
        loadingEl.innerHTML = `<div class="error">
          <h3>Unable to load earnings review</h3>
          <p>${error.message}</p>
          <p style="margin-top: 16px;"><a href="${backLink.href}" style="color: #00205b;">Go back</a></p>
        </div>`;
      }
    }

    function renderReport(data) {
      stopLoadingTimer();
      const priceClass = priceMove.startsWith('-') ? 'negative' : 'positive';

      // Check if data is in new structured format or old text format
      const isNewFormat = data.headline && data.keyTakeaways;

      // Build the HTML
      let html = `
        <div class="report-header">
          <div class="header-left">
            <div class="report-type">Earnings Review</div>
            <div class="company-name">${escapeHtml(data.companyName || data.ticker)}</div>
            <div class="ticker-info">${escapeHtml(data.ticker)} | ${escapeHtml(data.quarterInfo || 'Latest Quarter')}</div>
          </div>
          <div class="header-right">
            <div class="price-move-label">T+1 Earnings Move</div>
            <div class="price-move-badge ${priceClass}">${escapeHtml(priceMove)}</div>
          </div>
        </div>
      `;

      if (isNewFormat) {
        // New structured format
        html += renderStructuredReport(data);
      } else {
        // Legacy text format - parse the review content
        html += parseReviewContent(data.review);
      }

      // Add meta info
      html += `
        <div class="meta-info">
          Generated: ${new Date(data.generatedAt || Date.now()).toLocaleDateString('en-US', {
            month: 'long',
            day: 'numeric',
            year: 'numeric',
            hour: 'numeric',
            minute: '2-digit'
          })}
          ${data.cached ? ' (cached)' : ''}
        </div>
      `;

      // Hide loading, show report
      loadingEl.style.display = 'none';
      reportPage.innerHTML = html;
      reportPage.classList.add('visible');
    }

    function renderStructuredReport(data) {
      let html = '';

      // Headline Box
      if (data.headline) {
        html += `
          <div class="headline-box">
            <div class="headline-label">Headline</div>
            <div class="headline-text">${escapeHtml(data.headline)}</div>
          </div>
        `;
      }

      // Key Takeaways
      if (data.keyTakeaways && data.keyTakeaways.length > 0) {
        html += `<h2>Key Takeaways</h2><ul>`;
        for (const takeaway of data.keyTakeaways) {
          html += `<li>${escapeHtml(takeaway)}</li>`;
        }
        html += `</ul>`;
      }

      // Key Debates (Bull/Bear)
      if (data.keyDebates && (data.keyDebates.bullCase?.length > 0 || data.keyDebates.bearCase?.length > 0)) {
        html += `<h2>Key Debates</h2>`;
        html += `<div class="debates-container">`;

        // Bull Case
        if (data.keyDebates.bullCase && data.keyDebates.bullCase.length > 0) {
          html += `
            <div class="debate-case bull-case-box">
              <div class="case-header">Bull Case</div>
              <ul class="case-points">
          `;
          for (const point of data.keyDebates.bullCase) {
            html += `<li>${escapeHtml(point)}</li>`;
          }
          html += `</ul></div>`;
        }

        // Bear Case
        if (data.keyDebates.bearCase && data.keyDebates.bearCase.length > 0) {
          html += `
            <div class="debate-case bear-case-box">
              <div class="case-header">Bear Case</div>
              <ul class="case-points">
          `;
          for (const point of data.keyDebates.bearCase) {
            html += `<li>${escapeHtml(point)}</li>`;
          }
          html += `</ul></div>`;
        }

        html += `</div>`;
      }

      // Why It's Moving
      if (data.whyItsMoving) {
        html += `<h2>Why It's Moving</h2>`;
        html += `<p>${escapeHtml(data.whyItsMoving)}</p>`;
      }

      // Our View
      if (data.ourView) {
        html += `<h2>Our View</h2>`;
        html += `<p>${escapeHtml(data.ourView)}</p>`;
      }

      // Management Q&A
      if (data.managementQA && data.managementQA.length > 0) {
        html += `<h2>Management Q&A</h2>`;
        html += `<p style="font-style: italic; color: #666; margin-bottom: 16px;">Selected questions from the earnings call that reveal key debates and management thinking.</p>`;
        html += `<div class="qa-section">`;

        for (const qa of data.managementQA) {
          html += `
            <div class="qa-item">
              <div class="qa-analyst">${escapeHtml(qa.analyst || 'Analyst')}</div>
              <div class="qa-question">Q: ${escapeHtml(qa.question)}</div>
              <div class="qa-answer">${escapeHtml(qa.answer)}</div>
            </div>
          `;
        }

        html += `</div>`;
      }

      return html;
    }

    function parseReviewContent(review) {
      // Legacy: Convert markdown-style formatting to HTML with proper structure
      let html = review;

      // Extract headline if present (first bold text or **Headline:** section)
      const headlineMatch = html.match(/\*\*Headline[:\s]*\*\*\s*([^\n]+)/i);
      let headlineHtml = '';
      if (headlineMatch) {
        headlineHtml = `
          <div class="headline-box">
            <div class="headline-label">Headline</div>
            <div class="headline-text">${escapeHtml(headlineMatch[1].trim())}</div>
          </div>
        `;
        html = html.replace(headlineMatch[0], '');
      }

      // Convert section headers (##, ###, **Section:**)
      html = html
        .replace(/^### (.+)$/gm, '<h3>$1</h3>')
        .replace(/^## (.+)$/gm, '<h2>$1</h2>')
        .replace(/^\*\*([^*]+):\*\*\s*$/gm, '<h2>$1</h2>')
        .replace(/^\*\*([^*]+):\*\*/gm, '<h3>$1</h3>');

      // Convert inline bold
      html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');

      // Convert bullet points to list items
      html = html.replace(/^[-*]\s+(.+)$/gm, '<li>$1</li>');

      // Wrap consecutive list items in ul tags
      html = html.replace(/(<li>.*<\/li>\n?)+/g, (match) => `<ul>${match}</ul>`);

      // Convert paragraphs (double newlines)
      html = html.split(/\n\n+/).map(para => {
        para = para.trim();
        if (!para) return '';
        // Don't wrap if already wrapped in HTML tags
        if (para.startsWith('<h') || para.startsWith('<ul') || para.startsWith('<div')) {
          return para;
        }
        // Wrap plain text in paragraph tags
        return `<p>${para}</p>`;
      }).join('\n');

      // Clean up any remaining single newlines within paragraphs
      html = html.replace(/<\/p>\n<p>/g, '</p><p>');

      return headlineHtml + html;
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Load on page ready
    loadEarningsReview();
  </script>
</body>
</html>
