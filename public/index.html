<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Initiation of Coverage Report Generator</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Times New Roman', Georgia, serif;
      background: #fafafa;
      color: #1a1a1a;
      line-height: 1.7;
    }

    /* Landing Page */
    .landing {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 20px;
      background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%);
    }
    .landing-content {
      text-align: center;
      margin-top: -80px;
    }
    .logo {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 42px;
      font-weight: 700;
      color: #1a1a2e;
      margin-bottom: 40px;
      letter-spacing: -1px;
    }
    .search-box {
      display: flex;
      align-items: center;
      width: 520px;
      max-width: 90vw;
      padding: 8px 8px 8px 24px;
      border: none;
      border-radius: 32px;
      background: #fff;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      margin: 0 auto;
    }
    .search-box input {
      flex: 1;
      border: none;
      outline: none;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 18px;
      text-transform: uppercase;
      font-weight: 500;
      letter-spacing: 1px;
      background: transparent;
    }
    .search-box input::placeholder {
      text-transform: none;
      color: #aaa;
      font-weight: 400;
      letter-spacing: 0;
    }
    .search-box button {
      background: #1a1a2e;
      border: none;
      cursor: pointer;
      padding: 14px 28px;
      color: white;
      border-radius: 24px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 16px;
      font-weight: 600;
      transition: transform 0.2s, background 0.2s;
    }
    .search-box button:hover {
      background: #2d2d4a;
      transform: scale(1.02);
    }
    .search-box button:disabled {
      background: #999;
      transform: none;
      cursor: not-allowed;
    }
    .subtitle {
      margin-top: 28px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 15px;
      color: #666;
    }
    .portfolio-link {
      display: inline-block;
      margin-top: 20px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 14px;
      color: #00205b;
      text-decoration: none;
      padding: 8px 16px;
      border: 1px solid #00205b;
      border-radius: 20px;
      transition: background 0.2s, color 0.2s;
    }
    .portfolio-link:hover {
      background: #00205b;
      color: white;
    }

    /* Report Wrapper */
    .report-wrapper {
      display: none;
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
    }
    .report-wrapper.visible {
      display: block;
    }
    .report-toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .toolbar-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .regenerate-link {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 14px;
      color: #00205b;
      text-decoration: none;
    }
    .regenerate-link:hover {
      text-decoration: underline;
    }
    .back-link {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      color: #00205b;
      text-decoration: none;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .back-link:hover {
      text-decoration: underline;
    }
    .download-pdf-btn {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #00205b;
      color: white;
      border: none;
      padding: 10px 18px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: background 0.2s;
    }
    .download-pdf-btn:hover {
      background: #003087;
    }
    .download-pdf-btn:disabled {
      background: #999;
      cursor: not-allowed;
    }
    .download-pdf-btn svg {
      width: 16px;
      height: 16px;
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    /* Loading */
    .loading-container {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      text-align: center;
      padding: 100px 20px;
      background: white;
      box-shadow: 0 0 40px rgba(0,0,0,0.08);
    }
    .loading-title {
      font-size: 18px;
      margin-bottom: 30px;
      color: #333;
    }
    .loading-steps {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 30px;
    }
    .loading-step {
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 13px;
      background: #eee;
      color: #999;
      transition: background 0.3s, color 0.3s;
    }
    .loading-step.active {
      background: #00205b;
      color: white;
    }
    .progress-bar {
      width: 100%;
      max-width: 400px;
      height: 6px;
      background: #eee;
      border-radius: 3px;
      margin: 0 auto 20px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background: #00205b;
      border-radius: 3px;
      transition: width 1s ease-out;
    }
    .loading-time {
      font-size: 14px;
      color: #888;
    }
    .error {
      color: #c0392b;
      text-align: center;
      padding: 40px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    /* Report Page - Exact Goldman Style from Mockup */
    .page {
      background: white;
      padding: 48px 56px;
      box-shadow: 0 0 40px rgba(0,0,0,0.08);
    }

    /* Header */
    .report-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      border-bottom: 3px solid #00205b;
      padding-bottom: 20px;
      margin-bottom: 28px;
    }
    .header-left {
      flex: 1;
    }
    .report-type {
      font-family: Arial, sans-serif;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 2px;
      color: #00205b;
      margin-bottom: 10px;
      font-weight: 600;
    }
    .company-name {
      font-size: 38px;
      font-weight: bold;
      color: #00205b;
      margin-bottom: 4px;
    }
    .ticker-info {
      font-family: Arial, sans-serif;
      font-size: 13px;
      color: #666;
    }
    .header-right {
      text-align: right;
      font-family: Arial, sans-serif;
    }
    .price {
      font-size: 32px;
      font-weight: bold;
      color: #1a1a1a;
    }
    .rating-badge {
      display: inline-block;
      background: #00205b;
      color: white;
      padding: 6px 16px;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 1px;
      margin-top: 8px;
    }

    /* Investment Thesis Box */
    .thesis-box {
      background: #00205b;
      color: white;
      padding: 24px 28px;
      margin-bottom: 32px;
    }
    .thesis-header {
      display: flex;
      align-items: center;
      margin-bottom: 14px;
    }
    .thesis-icon {
      width: 26px;
      height: 26px;
      background: white;
      color: #00205b;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 15px;
      margin-right: 12px;
      font-family: Arial, sans-serif;
    }
    .thesis-label {
      font-family: Arial, sans-serif;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 2px;
      opacity: 0.8;
    }
    .thesis-text {
      font-size: 17px;
      line-height: 1.6;
    }
    .thesis-text strong {
      color: #7dd3fc;
    }

    /* Section Headers */
    .page h2 {
      font-family: Arial, sans-serif;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: #00205b;
      border-bottom: 1px solid #ddd;
      padding-bottom: 8px;
      margin-top: 40px;
      margin-bottom: 18px;
    }

    /* Sub-section Headers */
    .page h3 {
      font-family: Arial, sans-serif;
      font-size: 16px;
      font-weight: 600;
      color: #00205b;
      margin-top: 28px;
      margin-bottom: 12px;
    }
    .page h3 .num {
      display: inline-block;
      width: 28px;
      height: 28px;
      background: #00205b;
      color: white;
      border-radius: 50%;
      text-align: center;
      line-height: 28px;
      font-size: 13px;
      margin-right: 10px;
    }

    .page h4 {
      font-family: Arial, sans-serif;
      font-size: 13px;
      font-weight: 600;
      color: #444;
      margin-top: 20px;
      margin-bottom: 10px;
    }

    /* Appendix/Q&A styling */
    .page .qa-item {
      margin: 16px 0;
      padding-left: 16px;
      border-left: 3px solid #e0e0e0;
    }
    .page .qa-question {
      font-weight: 600;
      color: #00205b;
      margin-bottom: 8px;
    }
    .page .qa-answer {
      color: #444;
    }

    /* Body Text */
    .page p {
      margin-bottom: 14px;
      text-align: justify;
      font-size: 15px;
    }

    /* Key Insight Box (light blue) */
    .insight-box {
      background: #f0f4f8;
      border-left: 4px solid #00205b;
      padding: 16px 20px;
      margin: 24px 0;
    }
    .insight-label {
      font-family: Arial, sans-serif;
      font-size: 9px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #00205b;
      font-weight: 600;
      margin-bottom: 8px;
    }
    .insight-text {
      font-style: italic;
      color: #333;
      font-size: 15px;
    }

    /* Customer/Partner Boxes */
    .customer-box {
      background: #f0f7ff;
      border-left: 4px solid #2196f3;
      padding: 14px 18px;
      margin: 14px 0;
      border-radius: 0 4px 4px 0;
    }
    .customer-box strong {
      color: #1565c0;
      font-family: Arial, sans-serif;
      font-size: 14px;
    }
    .customer-box p {
      margin: 8px 0 0 0;
      font-size: 14px;
    }

    /* Competitor Section */
    .competitor-box {
      background: #fff8e1;
      border-left: 4px solid #ff9800;
      padding: 14px 18px;
      margin: 14px 0;
      border-radius: 0 4px 4px 0;
    }
    .competitor-box strong {
      color: #e65100;
      font-family: Arial, sans-serif;
      font-size: 14px;
    }
    .competitor-box p {
      margin: 8px 0 0 0;
      font-size: 14px;
    }

    /* Key Debates */
    .debate-box {
      background: #f5f5f5;
      border-left: 4px solid #00205b;
      padding: 16px 20px;
      margin: 16px 0;
      border-radius: 0 4px 4px 0;
    }
    .debate-question {
      font-family: Arial, sans-serif;
      font-size: 14px;
      font-weight: 600;
      color: #00205b;
      margin-bottom: 12px;
    }
    .bull-case {
      color: #2e7d32;
      margin: 8px 0;
      font-size: 14px;
    }
    .bull-case strong {
      font-family: Arial, sans-serif;
    }
    .bear-case {
      color: #c62828;
      margin: 8px 0;
      font-size: 14px;
    }
    .bear-case strong {
      font-family: Arial, sans-serif;
    }

    /* Data Table - Goldman Sachs Style */
    .table-container {
      margin: 20px 0;
    }
    .table-title {
      font-size: 11px;
      font-weight: bold;
      color: #00205b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
      border-bottom: 2px solid #00205b;
      padding-bottom: 4px;
    }
    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin: 0;
      font-family: 'Times New Roman', Georgia, serif;
      font-size: 12px;
    }
    .data-table thead tr {
      border-bottom: 2px solid #00205b;
    }
    .data-table th {
      background: transparent;
      color: #00205b;
      padding: 8px 12px;
      text-align: right;
      font-weight: bold;
      font-size: 11px;
      border-bottom: 2px solid #00205b;
    }
    .data-table th:first-child {
      text-align: left;
      width: 140px;
    }
    .data-table th.estimate {
      color: #666;
      font-style: italic;
    }
    .data-table td {
      padding: 6px 12px;
      border-bottom: 1px solid #e0e0e0;
      text-align: right;
    }
    .data-table td:first-child {
      text-align: left;
      font-weight: 500;
      color: #333;
    }
    .data-table tr:hover {
      background: #f8f9fa;
    }
    .data-table .metric-indent {
      padding-left: 24px;
      font-size: 11px;
      color: #555;
    }
    .data-table .negative {
      color: #c00;
    }
    .data-table .positive {
      color: #006600;
    }
    .data-table .estimate-col {
      background: #fafafa;
      color: #666;
      font-style: italic;
    }
    .data-table tfoot td {
      font-size: 9px;
      color: #888;
      padding-top: 12px;
      border: none;
      text-align: left;
    }

    /* Lists */
    .page ul, .page ol {
      margin: 14px 0 14px 24px;
      font-size: 15px;
    }
    .page li {
      margin-bottom: 8px;
    }

    /* Valuation Box */
    .valuation-summary {
      background: #e8f5e9;
      border: 1px solid #81c784;
      padding: 18px 22px;
      margin: 20px 0;
      border-radius: 4px;
    }
    .valuation-summary strong {
      color: #2e7d32;
      font-family: Arial, sans-serif;
    }

    /* Risk Box */
    .risk-box {
      background: #ffebee;
      border-left: 4px solid #ef5350;
      padding: 14px 18px;
      margin: 14px 0;
      border-radius: 0 4px 4px 0;
    }
    .risk-box strong {
      color: #c62828;
      font-family: Arial, sans-serif;
      font-size: 14px;
    }
    .risk-box p {
      margin: 8px 0 0 0;
      font-size: 14px;
    }

    /* Chat Widget */
    .chat-widget {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 1000;
      display: none;
    }
    .report-wrapper.visible .chat-widget,
    body.show-chat .chat-widget {
      display: block;
    }
    .chat-button {
      height: 48px;
      padding: 0 20px;
      border-radius: 24px;
      background: #00205b;
      color: white;
      border: none;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-size: 15px;
      font-weight: 500;
    }
    .chat-button:hover {
      background: #003087;
    }
    .chat-window {
      position: absolute;
      bottom: 70px;
      right: 0;
      width: 360px;
      height: 480px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.15);
      display: none;
      flex-direction: column;
      overflow: hidden;
    }
    .chat-window.open {
      display: flex;
    }
    .chat-header {
      background: #00205b;
      color: white;
      padding: 12px 16px;
      font-weight: 600;
      font-size: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .chat-minimize {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      padding: 4px;
      opacity: 0.8;
    }
    .chat-minimize:hover {
      opacity: 1;
    }
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .chat-message {
      max-width: 85%;
      padding: 10px 14px;
      border-radius: 12px;
      font-size: 14px;
      line-height: 1.5;
    }
    .chat-message.user {
      background: #e3f2fd;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }
    .chat-message.assistant {
      background: #f5f5f5;
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }
    .chat-input-area {
      padding: 12px;
      border-top: 1px solid #eee;
      display: flex;
      gap: 8px;
    }
    .chat-input {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid #ddd;
      border-radius: 20px;
      font-size: 14px;
      outline: none;
    }
    .chat-input:focus {
      border-color: #00205b;
    }
    .chat-send {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #00205b;
      color: white;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .chat-send:hover {
      background: #003087;
    }
    .chat-send:disabled {
      background: #ccc;
    }
  </style>
</head>
<body>
  <div class="landing" id="landing">
    <div class="landing-content">
      <div class="logo">Initiation of Coverage</div>
      <div class="search-box">
        <input type="text" id="ticker" placeholder="Enter ticker symbol..." maxlength="5">
        <button id="generate">GO</button>
      </div>
      <p class="subtitle">Generate hedge fund-style research reports</p>
      <a href="/portfolio.html" class="portfolio-link">Portfolio Update →</a>
    </div>
  </div>

  <div class="report-wrapper" id="report-wrapper">
    <div class="report-toolbar">
      <div class="toolbar-left">
        <a href="#" class="back-link" id="back-link">← New Search</a>
        <a href="#" class="regenerate-link" id="regenerate-link" style="display: none;">Generate New</a>
      </div>
      <button class="download-pdf-btn" id="download-pdf" style="display: none;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/>
        </svg>
        Download PDF
      </button>
    </div>

    <div class="loading-container" id="loading" style="display: none;">
      <div class="loading-title">Generating report for <strong id="loading-ticker"></strong></div>
      <div class="loading-steps">
        <span class="loading-step active">1. Research</span>
        <span class="loading-step">2. Draft</span>
        <span class="loading-step">3. Review</span>
        <span class="loading-step">4. Final</span>
      </div>
      <div class="progress-bar"><div class="progress-fill" style="width: 15%"></div></div>
      <div class="loading-time">This may take 1-2 minutes...</div>
    </div>

    <div class="page" id="report-page" style="display: none;"></div>
  </div>

  <div class="chat-widget" id="chat-widget">
    <div class="chat-window" id="chatWindow">
      <div class="chat-header">
        <span>Follow Up Questions?</span>
        <button class="chat-minimize" id="chatMinimize">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
        </button>
      </div>
      <div class="chat-messages" id="chatMessages"></div>
      <div class="chat-input-area">
        <input type="text" class="chat-input" id="chatInput" placeholder="Type your question...">
        <button class="chat-send" id="chatSend">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13M22 2L15 22L11 13M11 13L2 9L22 2"/></svg>
        </button>
      </div>
    </div>
    <button class="chat-button" id="chatButton">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
      <span>Chat</span>
    </button>
  </div>

  <script>
    const tickerInput = document.getElementById('ticker');
    const generateBtn = document.getElementById('generate');
    const landing = document.getElementById('landing');
    const reportWrapper = document.getElementById('report-wrapper');
    const reportPage = document.getElementById('report-page');
    const loadingEl = document.getElementById('loading');
    const loadingTicker = document.getElementById('loading-ticker');
    const backLink = document.getElementById('back-link');
    const chatWidget = document.getElementById('chat-widget');
    const downloadPdfBtn = document.getElementById('download-pdf');
    const regenerateLink = document.getElementById('regenerate-link');

    let currentTicker = '';
    let currentReport = '';
    let chatHistory = [];
    let loadingTimer = null;
    let loadingStartTime = null;

    // Regenerate handler
    regenerateLink.addEventListener('click', (e) => {
      e.preventDefault();
      if (currentTicker) {
        generateReport(true); // force refresh
      }
    });

    // PDF download handler
    downloadPdfBtn.addEventListener('click', async () => {
      if (!currentTicker) return;

      downloadPdfBtn.disabled = true;
      downloadPdfBtn.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite;">
          <circle cx="12" cy="12" r="10" stroke-dasharray="32" stroke-dashoffset="8"/>
        </svg>
        Generating...
      `;

      try {
        const response = await fetch('/api/download-pdf', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ticker: currentTicker })
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to generate PDF');
        }

        // Create blob and download
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${currentTicker}_Research_Report.pdf`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        a.remove();
      } catch (error) {
        console.error('PDF download error:', error);
        alert('Failed to download PDF: ' + error.message);
      }

      downloadPdfBtn.disabled = false;
      downloadPdfBtn.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/>
        </svg>
        Download PDF
      `;
    });

    generateBtn.addEventListener('click', () => generateReport(false));
    tickerInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') generateReport();
    });
    backLink.addEventListener('click', (e) => {
      e.preventDefault();
      showLanding();
    });

    // Chat handlers
    document.getElementById('chatButton').addEventListener('click', () => {
      document.getElementById('chatWindow').classList.toggle('open');
    });
    document.getElementById('chatMinimize').addEventListener('click', () => {
      document.getElementById('chatWindow').classList.remove('open');
    });
    document.getElementById('chatSend').addEventListener('click', sendChatMessage);
    document.getElementById('chatInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendChatMessage();
    });

    function showLanding() {
      landing.style.display = 'flex';
      reportWrapper.classList.remove('visible');
      chatWidget.style.display = 'none';
      downloadPdfBtn.style.display = 'none';
      regenerateLink.style.display = 'none';
      document.getElementById('chatWindow').classList.remove('open');
      stopLoadingTimer();
    }

    function startLoadingTimer() {
      loadingStartTime = Date.now();
      const loadingTimeEl = document.querySelector('.loading-time');
      const progressFill = document.querySelector('.progress-fill');
      const steps = document.querySelectorAll('.loading-step');

      // Reset to initial state
      progressFill.style.width = '5%';
      steps.forEach((s, i) => s.classList.toggle('active', i === 0));

      // Show estimated total time (v1 takes ~2 minutes with full research)
      loadingTimeEl.textContent = 'Estimated time: ~2 minutes';

      loadingTimer = setInterval(() => {
        const elapsed = Math.floor((Date.now() - loadingStartTime) / 1000);

        // Update progress bar (estimate ~120 seconds total, cap at 95%)
        const progress = Math.min(95, (elapsed / 120) * 100);
        progressFill.style.width = progress + '%';

        // Update active step based on elapsed time (adjusted for ~120s total)
        if (elapsed < 30) {
          // Step 1: Research (0-30s)
          steps.forEach((s, i) => s.classList.toggle('active', i === 0));
        } else if (elapsed < 60) {
          // Step 2: Draft (30-60s)
          steps.forEach((s, i) => s.classList.toggle('active', i <= 1));
        } else if (elapsed < 90) {
          // Step 3: Review (60-90s)
          steps.forEach((s, i) => s.classList.toggle('active', i <= 2));
        } else {
          // Step 4: Final (90-120s)
          steps.forEach((s, i) => s.classList.toggle('active', true));
        }
      }, 1000);
    }

    function stopLoadingTimer() {
      if (loadingTimer) {
        clearInterval(loadingTimer);
        loadingTimer = null;
      }
    }

    function showLoading(ticker) {
      landing.style.display = 'none';
      reportWrapper.classList.add('visible');
      loadingEl.style.display = 'block';
      reportPage.style.display = 'none';
      loadingTicker.textContent = ticker;
      chatWidget.style.display = 'none';
      downloadPdfBtn.style.display = 'none';
      startLoadingTimer();
    }

    function showReport(html) {
      stopLoadingTimer();
      loadingEl.style.display = 'none';
      reportPage.style.display = 'block';
      reportPage.innerHTML = html;
      chatWidget.style.display = 'block';
      downloadPdfBtn.style.display = 'inline-flex';
    }

    async function generateReport(forceRefresh = false) {
      const ticker = tickerInput.value.trim().toUpperCase() || currentTicker;
      if (!ticker) return;

      currentTicker = ticker;
      chatHistory = [];
      document.getElementById('chatMessages').innerHTML = '';

      showLoading(ticker);
      generateBtn.disabled = true;
      regenerateLink.style.display = 'none';

      try {
        const response = await fetch('/api/generate-report', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ticker, forceRefresh, version: 'v1' })
        });

        const data = await response.json();

        if (data.error) {
          stopLoadingTimer();
          loadingEl.innerHTML = '<div class="error">Error: ' + data.error + '</div>';
        } else {
          currentReport = data.report;
          showReport(data.html || convertToHTML(data.report, ticker));

          // Show regenerate link (always available)
          regenerateLink.style.display = 'inline';
        }
      } catch (error) {
        stopLoadingTimer();
        loadingEl.innerHTML = '<div class="error">Failed to generate report. Please try again.</div>';
      }

      generateBtn.disabled = false;
    }

    function convertToHTML(text, ticker) {
      // Basic fallback conversion if server doesn't provide HTML
      let html = text
        .replace(/^## (.*$)/gm, '<h2>$1</h2>')
        .replace(/^### (\d+)\. (.*$)/gm, '<h3><span class="num">$1</span>$2</h3>')
        .replace(/^### (.*$)/gm, '<h3>$1</h3>')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\n\n/g, '</p><p>')
        .replace(/\n/g, '<br>');

      return `
        <div class="report-header">
          <div class="header-left">
            <div class="report-type">Initiation of Coverage</div>
            <div class="company-name">${ticker}</div>
            <div class="ticker-info">${ticker}</div>
          </div>
          <div class="header-right">
            <div class="rating-badge">BUY</div>
          </div>
        </div>
        <p>${html}</p>
      `;
    }

    async function sendChatMessage() {
      const input = document.getElementById('chatInput');
      const question = input.value.trim();
      if (!question) return;

      addChatMessage('user', question);
      input.value = '';
      document.getElementById('chatSend').disabled = true;

      const typingDiv = document.createElement('div');
      typingDiv.className = 'chat-message assistant';
      typingDiv.style.color = '#888';
      typingDiv.style.fontStyle = 'italic';
      typingDiv.textContent = 'Thinking...';
      document.getElementById('chatMessages').appendChild(typingDiv);

      try {
        const response = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ticker: currentTicker, question, report: currentReport, chatHistory })
        });
        typingDiv.remove();
        const data = await response.json();
        if (data.error) {
          addChatMessage('assistant', 'Sorry, something went wrong.');
        } else {
          addChatMessage('assistant', data.answer);
          chatHistory.push({ role: 'user', content: question });
          chatHistory.push({ role: 'assistant', content: data.answer });
        }
      } catch (err) {
        typingDiv.remove();
        addChatMessage('assistant', 'Sorry, something went wrong.');
      }
      document.getElementById('chatSend').disabled = false;
      input.focus();
    }

    function addChatMessage(role, content) {
      const div = document.createElement('div');
      div.className = 'chat-message ' + role;
      div.innerHTML = content.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
      document.getElementById('chatMessages').appendChild(div);
      document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
    }
  </script>
</body>
</html>
