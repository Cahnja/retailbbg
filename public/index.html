<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Initiation of Coverage Report Generator</title>
  <style>
    /* ===== Reset & Base ===== */
    * { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      /* Brand */
      --brand-dark: #1e3a5f;
      --brand-mid: #2d5a87;
      --brand-light: #e8f0f7;

      /* Positive / Negative */
      --positive: #137333;
      --positive-bg: #e6f4ea;
      --negative: #c5221f;
      --negative-bg: #fce8e6;

      /* Neutrals */
      --text-primary: #1a1d21;
      --text-secondary: #5f6368;
      --text-tertiary: #80868b;
      --text-faint: #9aa0a6;

      --bg-page: #f5f6f8;
      --bg-card: #ffffff;
      --bg-subtle: #f8f9fa;

      --border: #e2e5e9;

      /* Sizing */
      --radius-card: 10px;
      --radius-sm: 6px;
      --shadow-card: 0 1px 3px rgba(0, 0, 0, 0.08);
      --shadow-hover: 0 4px 12px rgba(0, 0, 0, 0.12);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg-page);
      color: var(--text-primary);
      line-height: 1.7;
      -webkit-font-smoothing: antialiased;
    }

    /* ===== Navigation Banner ===== */
    .nav-strip {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 48px;
      background: var(--bg-card);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      padding: 0 24px;
      z-index: 1000;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
      color: var(--text-primary);
      margin-right: 24px;
      flex-shrink: 0;
    }

    .brand-ic {
      font-size: 16px;
      font-weight: 800;
      color: var(--brand-dark);
      letter-spacing: -1px;
    }

    .brand-sep {
      width: 1px;
      height: 20px;
      background: var(--border);
    }

    .nav-tabs {
      display: flex;
      align-items: stretch;
      height: 48px;
      gap: 0;
    }

    .nav-tab {
      text-decoration: none;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-tertiary);
      padding: 0 16px;
      display: flex;
      align-items: center;
      border-bottom: 2px solid transparent;
      transition: all 0.15s ease;
      white-space: nowrap;
    }

    .nav-tab:hover {
      color: var(--text-secondary);
    }

    .nav-tab.active {
      color: var(--brand-dark);
      border-bottom-color: var(--brand-dark);
      font-weight: 600;
    }

    @media (max-width: 900px) {
      .nav-tab {
        padding: 0 10px;
        font-size: 12px;
      }
    }

    @media (max-width: 480px) {
      .nav-tab {
        padding: 0 7px;
        font-size: 11px;
      }
      .brand-sep { display: none; }
    }

    /* ===== Bottom Tab Bar (Mobile) ===== */
    .bottom-tab-bar {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--brand-dark);
      z-index: 1000;
      padding-bottom: env(safe-area-inset-bottom);
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.15);
    }

    .bottom-tab-bar .tab-items {
      display: flex;
      justify-content: space-around;
      align-items: center;
      height: 56px;
    }

    .bottom-tab-bar .tab-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-decoration: none;
      color: rgba(255, 255, 255, 0.6);
      font-size: 9px;
      font-weight: 500;
      gap: 3px;
      padding: 6px 4px;
      min-width: 0;
      flex: 1;
      -webkit-tap-highlight-color: transparent;
      transition: color 0.2s;
    }

    .bottom-tab-bar .tab-item.active {
      color: white;
    }

    .bottom-tab-bar .tab-item svg {
      width: 22px;
      height: 22px;
    }

    .bottom-tab-bar .tab-label {
      line-height: 1;
    }

    @media (max-width: 768px) {
      .nav-strip {
        display: none;
      }

      .bottom-tab-bar {
        display: block;
      }

      body {
        padding-top: env(safe-area-inset-top);
        padding-bottom: calc(56px + env(safe-area-inset-bottom));
      }
    }

    /* ===== Landing Page ===== */
    .landing {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 20px;
      padding-top: 76px;
      background: linear-gradient(135deg, var(--bg-page) 0%, var(--border) 100%);
    }
    .landing-content {
      text-align: center;
      margin-top: -80px;
    }
    .logo {
      font-size: 42px;
      font-weight: 700;
      color: var(--brand-dark);
      margin-bottom: 40px;
      letter-spacing: -1px;
    }
    .search-box {
      display: flex;
      align-items: center;
      width: 520px;
      max-width: 90vw;
      padding: 8px 8px 8px 24px;
      border: none;
      border-radius: 32px;
      background: var(--bg-card);
      box-shadow: var(--shadow-hover);
      margin: 0 auto;
    }
    .search-box input {
      flex: 1;
      border: none;
      outline: none;
      font-size: 18px;
      text-transform: uppercase;
      font-weight: 500;
      letter-spacing: 1px;
      background: transparent;
    }
    .search-box input::placeholder {
      text-transform: none;
      color: var(--text-faint);
      font-weight: 400;
      letter-spacing: 0;
    }
    .search-box button {
      background: var(--brand-dark);
      border: none;
      cursor: pointer;
      padding: 14px 28px;
      color: white;
      border-radius: 24px;
      font-size: 16px;
      font-weight: 600;
      transition: transform 0.2s, background 0.2s;
    }
    .search-box button:hover {
      background: var(--brand-mid);
      transform: scale(1.02);
    }
    .search-box button:disabled {
      background: var(--text-faint);
      transform: none;
      cursor: not-allowed;
    }
    .subtitle {
      margin-top: 28px;
      font-size: 15px;
      color: var(--text-secondary);
    }

    /* ===== Report Wrapper ===== */
    .report-wrapper {
      display: none;
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
      padding-top: 76px;
    }
    .report-wrapper.visible {
      display: block;
    }
    .report-toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .toolbar-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .regenerate-link {
      font-size: 14px;
      color: var(--brand-dark);
      text-decoration: none;
    }
    .regenerate-link:hover {
      text-decoration: underline;
    }
    .back-link {
      color: var(--brand-dark);
      text-decoration: none;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .back-link:hover {
      text-decoration: underline;
    }
    .download-pdf-btn {
      background: var(--brand-dark);
      color: white;
      border: none;
      padding: 10px 18px;
      border-radius: var(--radius-sm);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: background 0.2s;
    }
    .download-pdf-btn:hover {
      background: var(--brand-mid);
    }
    .download-pdf-btn:disabled {
      background: var(--text-faint);
      cursor: not-allowed;
    }
    .download-pdf-btn svg {
      width: 16px;
      height: 16px;
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    /* ===== Loading ===== */
    .loading-container {
      text-align: center;
      padding: 100px 20px;
      background: var(--bg-card);
      box-shadow: var(--shadow-card);
      border-radius: var(--radius-card);
    }
    .loading-title {
      font-size: 18px;
      margin-bottom: 30px;
      color: var(--text-primary);
    }
    .loading-steps {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 30px;
    }
    .loading-step {
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 13px;
      background: var(--bg-subtle);
      color: var(--text-faint);
      transition: background 0.3s, color 0.3s;
    }
    .loading-step.active {
      background: var(--brand-dark);
      color: white;
    }
    .progress-bar {
      width: 100%;
      max-width: 400px;
      height: 6px;
      background: var(--border);
      border-radius: 3px;
      margin: 0 auto 20px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background: var(--brand-dark);
      border-radius: 3px;
      transition: width 1s ease-out;
    }
    .loading-time {
      font-size: 14px;
      color: var(--text-faint);
    }
    .error {
      color: var(--negative);
      text-align: center;
      padding: 40px;
    }

    /* ===== Report Page ===== */
    .page {
      background: var(--bg-card);
      padding: 48px 56px;
      box-shadow: var(--shadow-card);
      border-radius: var(--radius-card);
    }

    /* Header */
    .report-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      border-bottom: 3px solid var(--brand-dark);
      padding-bottom: 20px;
      margin-bottom: 28px;
    }
    .header-left {
      flex: 1;
    }
    .report-type {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 2px;
      color: var(--brand-dark);
      margin-bottom: 10px;
      font-weight: 600;
    }
    .company-name {
      font-size: 38px;
      font-weight: bold;
      color: var(--brand-dark);
      margin-bottom: 4px;
    }
    .ticker-info {
      font-size: 13px;
      color: var(--text-secondary);
    }
    .header-right {
      text-align: right;
    }
    .price {
      font-size: 32px;
      font-weight: bold;
      color: var(--text-primary);
      font-variant-numeric: tabular-nums;
    }
    .rating-badge {
      display: inline-block;
      background: var(--brand-dark);
      color: white;
      padding: 6px 16px;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 1px;
      margin-top: 8px;
      border-radius: var(--radius-sm);
    }

    /* Investment Thesis Box */
    .thesis-box {
      background: var(--brand-dark);
      color: white;
      padding: 24px 28px;
      margin-bottom: 32px;
      border-radius: var(--radius-sm);
    }
    .thesis-header {
      display: flex;
      align-items: center;
      margin-bottom: 14px;
    }
    .thesis-icon {
      width: 26px;
      height: 26px;
      background: white;
      color: var(--brand-dark);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 15px;
      margin-right: 12px;
    }
    .thesis-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 2px;
      opacity: 0.8;
    }
    .thesis-text {
      font-size: 17px;
      line-height: 1.6;
    }
    .thesis-text strong {
      color: #7dd3fc;
    }

    /* Section Headers */
    .page h2 {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: var(--brand-dark);
      border-bottom: 1px solid var(--border);
      padding-bottom: 8px;
      margin-top: 40px;
      margin-bottom: 18px;
    }

    /* Sub-section Headers */
    .page h3 {
      font-size: 16px;
      font-weight: 600;
      color: var(--brand-dark);
      margin-top: 28px;
      margin-bottom: 12px;
    }
    .page h3 .num {
      display: inline-block;
      width: 28px;
      height: 28px;
      background: var(--brand-dark);
      color: white;
      border-radius: 50%;
      text-align: center;
      line-height: 28px;
      font-size: 13px;
      margin-right: 10px;
    }

    .page h4 {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-top: 20px;
      margin-bottom: 10px;
    }

    /* Appendix/Q&A styling */
    .page .qa-item {
      margin: 16px 0;
      padding-left: 16px;
      border-left: 3px solid var(--border);
    }
    .page .qa-question {
      font-weight: 600;
      color: var(--brand-dark);
      margin-bottom: 8px;
    }
    .page .qa-answer {
      color: var(--text-secondary);
    }

    /* Body Text */
    .page p {
      margin-bottom: 14px;
      text-align: justify;
      font-size: 15px;
    }

    /* Key Insight Box */
    .insight-box {
      background: var(--brand-light);
      border-left: 4px solid var(--brand-dark);
      padding: 16px 20px;
      margin: 24px 0;
      border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
    }
    .insight-label {
      font-size: 9px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--brand-dark);
      font-weight: 600;
      margin-bottom: 8px;
    }
    .insight-text {
      font-style: italic;
      color: var(--text-secondary);
      font-size: 15px;
    }

    /* Customer/Partner Boxes */
    .customer-box {
      background: #f0f7ff;
      border-left: 4px solid #2196f3;
      padding: 14px 18px;
      margin: 14px 0;
      border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
    }
    .customer-box strong {
      color: #1565c0;
      font-size: 14px;
    }
    .customer-box p {
      margin: 8px 0 0 0;
      font-size: 14px;
    }

    /* Competitor Section */
    .competitor-box {
      background: #fff8e1;
      border-left: 4px solid #ff9800;
      padding: 14px 18px;
      margin: 14px 0;
      border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
    }
    .competitor-box strong {
      color: #e65100;
      font-size: 14px;
    }
    .competitor-box p {
      margin: 8px 0 0 0;
      font-size: 14px;
    }

    /* Key Debates */
    .debate-box {
      background: var(--bg-subtle);
      border-left: 4px solid var(--brand-dark);
      padding: 16px 20px;
      margin: 16px 0;
      border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
    }
    .debate-question {
      font-size: 14px;
      font-weight: 600;
      color: var(--brand-dark);
      margin-bottom: 12px;
    }
    .bull-case {
      color: var(--positive);
      margin: 8px 0;
      font-size: 14px;
    }
    .bear-case {
      color: var(--negative);
      margin: 8px 0;
      font-size: 14px;
    }

    /* Data Table */
    .table-container {
      margin: 20px 0;
    }
    .table-title {
      font-size: 11px;
      font-weight: bold;
      color: var(--brand-dark);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
      border-bottom: 2px solid var(--brand-dark);
      padding-bottom: 4px;
    }
    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin: 0;
      font-size: 12px;
      font-variant-numeric: tabular-nums;
    }
    .data-table thead tr {
      border-bottom: 2px solid var(--brand-dark);
    }
    .data-table th {
      background: transparent;
      color: var(--brand-dark);
      padding: 8px 12px;
      text-align: right;
      font-weight: bold;
      font-size: 11px;
      border-bottom: 2px solid var(--brand-dark);
    }
    .data-table th:first-child {
      text-align: left;
      width: 140px;
    }
    .data-table th.estimate {
      color: var(--text-secondary);
      font-style: italic;
    }
    .data-table td {
      padding: 6px 12px;
      border-bottom: 1px solid var(--border);
      text-align: right;
    }
    .data-table td:first-child {
      text-align: left;
      font-weight: 500;
      color: var(--text-primary);
    }
    .data-table tr:hover {
      background: var(--bg-subtle);
    }
    .data-table .metric-indent {
      padding-left: 24px;
      font-size: 11px;
      color: var(--text-secondary);
    }
    .data-table .negative {
      color: var(--negative);
    }
    .data-table .positive {
      color: var(--positive);
    }
    .data-table .estimate-col {
      background: var(--bg-subtle);
      color: var(--text-secondary);
      font-style: italic;
    }
    .data-table tfoot td {
      font-size: 9px;
      color: var(--text-faint);
      padding-top: 12px;
      border: none;
      text-align: left;
    }

    /* Lists */
    .page ul, .page ol {
      margin: 14px 0 14px 24px;
      font-size: 15px;
    }
    .page li {
      margin-bottom: 8px;
    }

    /* Valuation Box */
    .valuation-summary {
      background: var(--positive-bg);
      border: 1px solid var(--positive);
      padding: 18px 22px;
      margin: 20px 0;
      border-radius: var(--radius-sm);
    }
    .valuation-summary strong {
      color: var(--positive);
    }

    /* Risk Box */
    .risk-box {
      background: var(--negative-bg);
      border-left: 4px solid var(--negative);
      padding: 14px 18px;
      margin: 14px 0;
      border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
    }
    .risk-box strong {
      color: var(--negative);
      font-size: 14px;
    }
    .risk-box p {
      margin: 8px 0 0 0;
      font-size: 14px;
    }

    /* ===== Chat Widget ===== */
    .chat-widget {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 1000;
      display: none;
    }
    .report-wrapper.visible .chat-widget,
    body.show-chat .chat-widget {
      display: block;
    }
    .chat-button {
      height: 48px;
      padding: 0 20px;
      border-radius: 24px;
      background: var(--brand-dark);
      color: white;
      border: none;
      cursor: pointer;
      box-shadow: var(--shadow-hover);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-size: 15px;
      font-weight: 500;
    }
    .chat-button:hover {
      background: var(--brand-mid);
    }
    .chat-window {
      position: absolute;
      bottom: 70px;
      right: 0;
      width: 360px;
      height: 480px;
      background: var(--bg-card);
      border-radius: var(--radius-card);
      box-shadow: var(--shadow-hover);
      display: none;
      flex-direction: column;
      overflow: hidden;
    }
    .chat-window.open {
      display: flex;
    }
    .chat-header {
      background: var(--brand-dark);
      color: white;
      padding: 12px 16px;
      font-weight: 600;
      font-size: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .chat-minimize {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      padding: 4px;
      opacity: 0.8;
    }
    .chat-minimize:hover {
      opacity: 1;
    }
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .chat-message {
      max-width: 85%;
      padding: 10px 14px;
      border-radius: var(--radius-card);
      font-size: 14px;
      line-height: 1.5;
    }
    .chat-message.user {
      background: var(--brand-light);
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }
    .chat-message.assistant {
      background: var(--bg-subtle);
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }
    .chat-input-area {
      padding: 12px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 8px;
    }
    .chat-input {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: 20px;
      font-size: 14px;
      outline: none;
    }
    .chat-input:focus {
      border-color: var(--brand-dark);
    }
    .chat-send {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--brand-dark);
      color: white;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .chat-send:hover {
      background: var(--brand-mid);
    }
    .chat-send:disabled {
      background: var(--border);
    }
  </style>
</head>
<body>
  <nav class="nav-strip">
    <a href="/market" class="brand">
      <span class="brand-ic">IC</span>
    </a>
    <div class="brand-sep"></div>
    <div class="nav-tabs">
      <a href="/market" class="nav-tab">Market Update</a>
      <a href="/top-movers" class="nav-tab">Top Movers</a>
      <a href="/portfolio" class="nav-tab">Portfolio</a>
      <a href="/ideageneration" class="nav-tab">Idea Generation</a>
      <a href="/index.html" class="nav-tab active">Initiation</a>
    </div>
  </nav>

  <div class="landing" id="landing">
    <div class="landing-content">
      <div class="logo">Initiation of Coverage</div>
      <div class="search-box">
        <input type="text" id="ticker" placeholder="Enter ticker symbol..." maxlength="5">
        <button id="generate">GO</button>
      </div>
      <p class="subtitle">Generate hedge fund-style research reports</p>
    </div>
  </div>

  <div class="report-wrapper" id="report-wrapper">
    <div class="report-toolbar">
      <div class="toolbar-left">
        <a href="#" class="back-link" id="back-link">‚Üê New Search</a>
        <a href="#" class="regenerate-link" id="regenerate-link" style="display: none;">Generate New</a>
      </div>
      <button class="download-pdf-btn" id="download-pdf" style="display: none;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/>
        </svg>
        Download PDF
      </button>
    </div>

    <div class="loading-container" id="loading" style="display: none;">
      <div class="loading-title">Generating report for <strong id="loading-ticker"></strong></div>
      <div class="loading-steps">
        <span class="loading-step active">1. Research</span>
        <span class="loading-step">2. Draft</span>
        <span class="loading-step">3. Review</span>
        <span class="loading-step">4. Final</span>
      </div>
      <div class="progress-bar"><div class="progress-fill" style="width: 15%"></div></div>
      <div class="loading-time">This may take 1-2 minutes...</div>
    </div>

    <div class="page" id="report-page" style="display: none;"></div>
  </div>

  <div class="chat-widget" id="chat-widget">
    <div class="chat-window" id="chatWindow">
      <div class="chat-header">
        <span>Follow Up Questions?</span>
        <button class="chat-minimize" id="chatMinimize">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
        </button>
      </div>
      <div class="chat-messages" id="chatMessages"></div>
      <div class="chat-input-area">
        <input type="text" class="chat-input" id="chatInput" placeholder="Type your question...">
        <button class="chat-send" id="chatSend">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13M22 2L15 22L11 13M11 13L2 9L22 2"/></svg>
        </button>
      </div>
    </div>
    <button class="chat-button" id="chatButton">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
      <span>Chat</span>
    </button>
  </div>

  <!-- Bottom Tab Bar (Mobile) -->
  <nav class="bottom-tab-bar">
    <div class="tab-items">
      <a href="/market" class="tab-item">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"/></svg>
        <span class="tab-label">Market</span>
      </a>
      <a href="/top-movers" class="tab-item">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>
        <span class="tab-label">Top Movers</span>
      </a>
      <a href="/portfolio" class="tab-item">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/></svg>
        <span class="tab-label">Portfolio</span>
      </a>
      <a href="/ideageneration" class="tab-item">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>
        <span class="tab-label">Ideas</span>
      </a>
      <a href="/index.html" class="tab-item active">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
        <span class="tab-label">Initiation</span>
      </a>
    </div>
  </nav>

  <script>
    const tickerInput = document.getElementById('ticker');
    const generateBtn = document.getElementById('generate');
    const landing = document.getElementById('landing');
    const reportWrapper = document.getElementById('report-wrapper');
    const reportPage = document.getElementById('report-page');
    const loadingEl = document.getElementById('loading');
    const loadingTicker = document.getElementById('loading-ticker');
    const backLink = document.getElementById('back-link');
    const chatWidget = document.getElementById('chat-widget');
    const downloadPdfBtn = document.getElementById('download-pdf');
    const regenerateLink = document.getElementById('regenerate-link');

    let currentTicker = '';
    let currentReport = '';
    let chatHistory = [];
    let loadingTimer = null;
    let loadingStartTime = null;

    // Regenerate handler
    regenerateLink.addEventListener('click', (e) => {
      e.preventDefault();
      if (currentTicker) {
        generateReport(true); // force refresh
      }
    });

    // PDF download handler
    downloadPdfBtn.addEventListener('click', async () => {
      if (!currentTicker) return;

      downloadPdfBtn.disabled = true;
      downloadPdfBtn.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite;">
          <circle cx="12" cy="12" r="10" stroke-dasharray="32" stroke-dashoffset="8"/>
        </svg>
        Generating...
      `;

      try {
        const response = await fetch('/api/download-pdf', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ticker: currentTicker })
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to generate PDF');
        }

        // Create blob and download
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${currentTicker}_Research_Report.pdf`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        a.remove();
      } catch (error) {
        console.error('PDF download error:', error);
        alert('Failed to download PDF: ' + error.message);
      }

      downloadPdfBtn.disabled = false;
      downloadPdfBtn.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/>
        </svg>
        Download PDF
      `;
    });

    generateBtn.addEventListener('click', () => generateReport(false));
    tickerInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') generateReport();
    });
    backLink.addEventListener('click', (e) => {
      e.preventDefault();
      showLanding();
      // Reset URL to initiation page when going back to landing
      history.pushState({}, '', '/index.html');
    });

    // Check URL for ticker on page load (clean URL routing)
    (function checkUrlForTicker() {
      const path = window.location.pathname;
      if (path.length > 1 && !path.includes('.')) {
        const ticker = path.substring(1).toUpperCase();
        // Validate ticker format (1-5 uppercase letters)
        if (ticker && /^[A-Z]{1,5}$/.test(ticker)) {
          tickerInput.value = ticker;
          generateReport(); // Auto-generate report
        }
      }
    })();

    // Handle browser back/forward navigation
    window.addEventListener('popstate', (e) => {
      const path = window.location.pathname;
      if (path === '/' || path === '') {
        showLanding();
      } else if (path.length > 1 && !path.includes('.')) {
        const ticker = path.substring(1).toUpperCase();
        if (ticker && /^[A-Z]{1,5}$/.test(ticker)) {
          tickerInput.value = ticker;
          generateReport();
        }
      }
    });

    // Chat handlers
    document.getElementById('chatButton').addEventListener('click', () => {
      document.getElementById('chatWindow').classList.toggle('open');
    });
    document.getElementById('chatMinimize').addEventListener('click', () => {
      document.getElementById('chatWindow').classList.remove('open');
    });
    document.getElementById('chatSend').addEventListener('click', sendChatMessage);
    document.getElementById('chatInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendChatMessage();
    });

    function showLanding() {
      landing.style.display = 'flex';
      reportWrapper.classList.remove('visible');
      chatWidget.style.display = 'none';
      downloadPdfBtn.style.display = 'none';
      regenerateLink.style.display = 'none';
      document.getElementById('chatWindow').classList.remove('open');
      stopLoadingTimer();
    }

    function startLoadingTimer() {
      loadingStartTime = Date.now();
      const loadingTimeEl = document.querySelector('.loading-time');
      const progressFill = document.querySelector('.progress-fill');
      const steps = document.querySelectorAll('.loading-step');

      // Reset to initial state
      progressFill.style.width = '5%';
      steps.forEach((s, i) => s.classList.toggle('active', i === 0));

      // Show estimated total time (v1 takes ~2 minutes with full research)
      loadingTimeEl.textContent = 'Estimated time: ~2 minutes';

      loadingTimer = setInterval(() => {
        const elapsed = Math.floor((Date.now() - loadingStartTime) / 1000);

        // Update progress bar (estimate ~120 seconds total, cap at 95%)
        const progress = Math.min(95, (elapsed / 120) * 100);
        progressFill.style.width = progress + '%';

        // Update active step based on elapsed time (adjusted for ~120s total)
        if (elapsed < 30) {
          // Step 1: Research (0-30s)
          steps.forEach((s, i) => s.classList.toggle('active', i === 0));
        } else if (elapsed < 60) {
          // Step 2: Draft (30-60s)
          steps.forEach((s, i) => s.classList.toggle('active', i <= 1));
        } else if (elapsed < 90) {
          // Step 3: Review (60-90s)
          steps.forEach((s, i) => s.classList.toggle('active', i <= 2));
        } else {
          // Step 4: Final (90-120s)
          steps.forEach((s, i) => s.classList.toggle('active', true));
        }
      }, 1000);
    }

    function stopLoadingTimer() {
      if (loadingTimer) {
        clearInterval(loadingTimer);
        loadingTimer = null;
      }
    }

    function showLoading(ticker) {
      landing.style.display = 'none';
      reportWrapper.classList.add('visible');
      loadingEl.style.display = 'block';
      reportPage.style.display = 'none';
      loadingTicker.textContent = ticker;
      chatWidget.style.display = 'none';
      downloadPdfBtn.style.display = 'none';
      startLoadingTimer();
    }

    function showReport(html) {
      stopLoadingTimer();
      loadingEl.style.display = 'none';
      reportPage.style.display = 'block';
      reportPage.innerHTML = html;
      chatWidget.style.display = 'block';
      downloadPdfBtn.style.display = 'inline-flex';
    }

    async function generateReport(forceRefresh = false) {
      const ticker = tickerInput.value.trim().toUpperCase() || currentTicker;
      if (!ticker) return;

      currentTicker = ticker;
      chatHistory = [];
      document.getElementById('chatMessages').innerHTML = '';

      showLoading(ticker);
      generateBtn.disabled = true;
      regenerateLink.style.display = 'none';

      try {
        const response = await fetch('/api/generate-report', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ticker, forceRefresh, version: 'v1' })
        });

        const data = await response.json();

        if (data.error) {
          stopLoadingTimer();
          loadingEl.innerHTML = '<div class="error">Error: ' + data.error + '</div>';
        } else {
          currentReport = data.report;
          showReport(data.html || convertToHTML(data.report, ticker));

          // Update URL to clean format (e.g., /tsla)
          history.pushState({ticker: ticker}, '', '/' + ticker.toLowerCase());

          // Show regenerate link
          regenerateLink.style.display = 'inline';
          regenerateLink.textContent = 'Generate New';
          regenerateLink.style.color = '#00205b';
          regenerateLink.style.fontWeight = 'normal';
        }
      } catch (error) {
        stopLoadingTimer();
        loadingEl.innerHTML = '<div class="error">Failed to generate report. Please try again.</div>';
      }

      generateBtn.disabled = false;
    }

    function convertToHTML(text, ticker) {
      // Basic fallback conversion if server doesn't provide HTML
      let html = text
        .replace(/^## (.*$)/gm, '<h2>$1</h2>')
        .replace(/^### (\d+)\. (.*$)/gm, '<h3><span class="num">$1</span>$2</h3>')
        .replace(/^### (.*$)/gm, '<h3>$1</h3>')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\n\n/g, '</p><p>')
        .replace(/\n/g, '<br>');

      return `
        <div class="report-header">
          <div class="header-left">
            <div class="report-type">Initiation of Coverage</div>
            <div class="company-name">${ticker}</div>
            <div class="ticker-info">${ticker}</div>
          </div>
          <div class="header-right">
            <div class="rating-badge">BUY</div>
          </div>
        </div>
        <p>${html}</p>
      `;
    }

    async function sendChatMessage() {
      const input = document.getElementById('chatInput');
      const question = input.value.trim();
      if (!question) return;

      addChatMessage('user', question);
      input.value = '';
      document.getElementById('chatSend').disabled = true;

      const typingDiv = document.createElement('div');
      typingDiv.className = 'chat-message assistant';
      typingDiv.style.color = '#888';
      typingDiv.style.fontStyle = 'italic';
      typingDiv.textContent = 'Thinking...';
      document.getElementById('chatMessages').appendChild(typingDiv);

      try {
        const response = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ticker: currentTicker, question, report: currentReport, chatHistory })
        });
        typingDiv.remove();
        const data = await response.json();
        if (data.error) {
          addChatMessage('assistant', 'Sorry, something went wrong.');
        } else {
          addChatMessage('assistant', data.answer);
          chatHistory.push({ role: 'user', content: question });
          chatHistory.push({ role: 'assistant', content: data.answer });
        }
      } catch (err) {
        typingDiv.remove();
        addChatMessage('assistant', 'Sorry, something went wrong.');
      }
      document.getElementById('chatSend').disabled = false;
      input.focus();
    }

    function addChatMessage(role, content) {
      const div = document.createElement('div');
      div.className = 'chat-message ' + role;
      div.innerHTML = content.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
      document.getElementById('chatMessages').appendChild(div);
      document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
    }
  </script>
</body>
</html>
